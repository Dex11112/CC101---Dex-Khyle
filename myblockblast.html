<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Block Blast — Single File</title>
<style>
  :root{
    --accent:#ffcc00;
    --bg:#0b1020;
    --panel:rgba(255,255,255,0.04);
    --glass:rgba(255,255,255,0.03);
    --text:#e9eef8;
    --muted:rgba(233,238,248,0.65);
    --neon:#00ffd5;
    --font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:var(--font-family);-webkit-tap-highlight-color:transparent}
  .app {
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    color:var(--text);
    overflow:hidden;
  }
  .game-wrap {
    position:relative;
    width:900px;
    max-width:96vw;
    aspect-ratio:16/9;
    background:linear-gradient(180deg,#07102a 0%, #0b1726 100%);
    box-shadow: 0 8px 30px rgba(0,0,0,0.7), inset 0 1px 0 rgba(255,255,255,0.02);
    border-radius:12px;
    overflow:hidden;
  }
  canvas { display:block; width:100%; height:100%; background:transparent; }
  .ui {
    position:absolute; left:12px; top:12px; right:12px; pointer-events:none;
    display:flex; justify-content:space-between; gap:12px;
  }
  .left-ui, .right-ui { pointer-events:auto; display:flex; gap:8px; align-items:center; }
  .panel {
    background:var(--panel);
    padding:8px 10px;
    border-radius:8px;
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,0.03);
    display:flex; gap:8px; align-items:center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.35);
  }
  .logo { font-weight:700; font-size:16px; color:var(--accent); letter-spacing:1px; }
  .small { font-size:13px; color:var(--muted) }
  .big { font-size:18px; font-weight:700 }
  .btn {
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.03));
    color:var(--text);
    border:none; padding:8px 12px; border-radius:8px; cursor:pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    transition:transform .12s ease, opacity .12s;
    font-weight:600;
  }
  .btn:active { transform:translateY(2px) }
  .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); }
  .bottom-controls {
    position:absolute; bottom:12px; left:12px; right:12px; display:flex; justify-content:space-between; pointer-events:none;
  }
  .control-group { pointer-events:auto; display:flex; gap:8px; align-items:center; }
  .overlay {
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.4));
    z-index:40; padding:20px; box-sizing:border-box;
  }
  .panel-modal {
    width:min(720px,95%); max-height:86vh; overflow:auto; border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); padding:18px;
    box-shadow:0 12px 30px rgba(0,0,0,0.6);
  }
  .center { display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center; }
  .title { font-size:52px; font-weight:800; letter-spacing:1px; color:var(--accent); text-shadow: 0 4px 28px rgba(0,0,0,0.8), 0 0 18px rgba(0,255,213,0.05) }
  .subtitle { color:var(--muted); font-size:15px }
  .menu-buttons { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; justify-content:center }
  .shop-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-top:12px }
  .shop-card {
    background:var(--glass); border-radius:10px; padding:8px; display:flex; flex-direction:column; gap:8px; align-items:center;
    border:1px solid rgba(255,255,255,0.02);
  }
  .bg-preview { width:100%; height:80px; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.03) }
  .muted-sm { color:var(--muted); font-size:13px }
  input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--text); width:220px }
  .highscore-row { display:flex; justify-content:space-between; gap:12px; padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,0.02) }
  .coin {
    width:18px;height:18px;border-radius:50%;background:radial-gradient(circle at 40% 35%, #fff2a6, #ffb300);display:inline-block;border:1px solid rgba(0,0,0,0.2);
    box-shadow: 0 2px 6px rgba(255,176,0,0.2) inset;
  }

  @media (max-width:520px){
    .title { font-size:34px }
    .game-wrap { aspect-ratio:16/9; border-radius:8px }
    .panel { padding:6px 8px; border-radius:8px }
    input[type="text"]{ width:160px }
  }

  .fade-in { animation: fadeIn .45s ease both }
  @keyframes fadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
  .pop { animation: pop .28s ease both }
  @keyframes pop { 0%{ transform:scale(.9); opacity:0} 60%{ transform:scale(1.03)} 100%{transform:none; opacity:1} }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="game-wrap" id="gameWrap" aria-label="Block Blast game">
    <canvas id="gameCanvas" width="1280" height="720"></canvas>

    <div class="ui">
      <div class="left-ui">
        <div class="panel logo">BLOCK BLAST</div>
        <div class="panel small" id="scorePanel">Score: 0</div>
      </div>
      <div class="right-ui">
        <div class="panel small" id="coinsPanel"><span class="coin" style="margin-right:8px"></span> <span id="coinsCount">0</span></div>
        <div class="panel small" id="highPanel">High: 0 (<span id="highName">—</span>)</div>
      </div>
    </div>

    <div class="bottom-controls">
      <div class="control-group">
        <button class="btn ghost" id="btnMenu">Menu</button>
        <button class="btn ghost" id="btnShop">Shop</button>
        <button class="btn ghost" id="btnHigh">High Score</button>
      </div>
      <div class="control-group">
        <button class="btn" id="btnLaunch">Launch</button>
        <button class="btn" id="btnMute">Mute</button>
      </div>
    </div>
  </div>
</div>

<div id="overlayMenu" class="overlay" style="display:flex; z-index:50; pointer-events:auto">
  <div class="panel-modal center pop" style="max-width:820px;">
    <div class="title">BLOCK BLAST</div>
    <div class="subtitle">Classic breakout with coins, a shop, and neon backgrounds — made in one file.</div>
    <div class="menu-buttons">
      <button class="btn" id="menuPlay">Play</button>
      <button class="btn ghost" id="menuShop">Shop</button>
      <button class="btn ghost" id="menuHigh">High Score</button>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; align-items:center">
      <div class="muted-sm">Your name:</div>
      <input type="text" id="playerNameInput" placeholder="Player" maxlength="12" />
    </div>
    <div style="margin-top:12px; width:100%; display:flex; gap:10px; align-items:center; justify-content:center">
      <div class="muted-sm">Coins:</div>
      <div class="panel small"><span class="coin"></span> <span id="menuCoins">0</span></div>
      <div class="muted-sm">High:</div>
      <div class="panel small" id="menuHighSmall">0 (<span id="menuHighName">—</span>)</div>
    </div>
  </div>
</div>

<div id="overlayShop" class="overlay" style="display:none; z-index:60; pointer-events:auto">
  <div class="panel-modal">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div style="display:flex; gap:8px; align-items:center">
        <div class="logo">SHOP</div>
        <div class="muted-sm">Purchase backgrounds with coins</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="panel small"><span class="coin"></span> <span id="shopCoins">0</span></div>
        <button class="btn ghost" id="closeShop">Close</button>
      </div>
    </div>

    <div class="shop-list" id="shopList" style="margin-top:12px"></div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
      <button class="btn ghost" id="shopBack">Back</button>
    </div>
  </div>
</div>

<div id="overlayHigh" class="overlay" style="display:none; z-index:70; pointer-events:auto">
  <div class="panel-modal">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div class="logo">HIGH SCORE</div>
      <div>
        <button class="btn ghost" id="closeHigh">Close</button>
      </div>
    </div>
    <div style="margin-top:12px">
      <div class="highscore-row" style="font-weight:700;">
        <div>Name</div><div>Score</div>
      </div>
      <div id="highList"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d', { alpha: false });
  const w=canvas.width, h=canvas.height;
  const ratio = w/h;

  const scorePanel = document.getElementById('scorePanel');
  const coinsPanel = document.getElementById('coinsCount');
  const coinsPanelFull = document.getElementById('coinsPanel');
  const highPanel = document.getElementById('highPanel');
  const highName = document.getElementById('highName');
  const overlayMenu = document.getElementById('overlayMenu');
  const overlayShop = document.getElementById('overlayShop');
  const overlayHigh = document.getElementById('overlayHigh');
  const playerNameInput = document.getElementById('playerNameInput');
  const menuCoins = document.getElementById('menuCoins');
  const menuHigh = document.getElementById('menuHighSmall');
  const menuHighName = document.getElementById('menuHighName');

  const btnLaunch = document.getElementById('btnLaunch');
  const btnMute = document.getElementById('btnMute');
  const btnMenu = document.getElementById('btnMenu');
  const btnShop = document.getElementById('btnShop');
  const btnHigh = document.getElementById('btnHigh');

  const menuPlay = document.getElementById('menuPlay');
  const menuShopBtn = document.getElementById('menuShop');
  const menuHighBtn = document.getElementById('menuHigh');

  const shopList = document.getElementById('shopList');
  const shopCoins = document.getElementById('shopCoins');
  const closeShop = document.getElementById('closeShop');
  const overlayShopBack = document.getElementById('shopBack');

  const closeHigh = document.getElementById('closeHigh');
  const highList = document.getElementById('highList');

  const LS = window.localStorage;
  function lsGet(key, def=null) { try { const v=LS.getItem(key); return v===null?def:JSON.parse(v); } catch(e){return def;} }
  function lsSet(key, val){ try{ LS.setItem(key, JSON.stringify(val)); }catch(e){} }
  function lsRemove(key){ try{ LS.removeItem(key); }catch(e){} }

  const KEY = {
    HIGHSCORE: 'bb_highscore',
    HIGHSCORE_NAME: 'bb_highscore_name',
    COINS: 'bb_coins',
    BG_BOUGHT_PREFIX: 'bb_bought_BG_',
    BG_SELECTED: 'bb_selected_BG',
    HIGHLIST: 'bb_highlist'
  };

  let gameRunning=false;
  let score=0;
  let coins=lsGet(KEY.COINS, 0)|0;
  let playerName = lsGet(KEY.HIGHSCORE_NAME, 'Player') || 'Player';
  let highscore = lsGet(KEY.HIGHSCORE, 0)|0;
  let highscorename = lsGet(KEY.HIGHSCORE_NAME, 'Player') || 'Player';

  const backgrounds = [
    { id:'neon_free', name:'Neon Grid (Free)', preview: 'linear-gradient(135deg,#001026,#001024 50%, #061a3a)', cost:0, css: function(g){
        const g1 = ctx.createLinearGradient(0,0,w,h);
        g1.addColorStop(0,'#020b18'); g1.addColorStop(1,'#001023');
        return g1;
      }
    },
    { id:'sunset', name:'Sunset', cost:25, preview:'linear-gradient(135deg,#ff9a9e,#f6d365)', css: ()=>{ const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#ff9a9e'); g.addColorStop(1,'#f6d365'); return g; } },
    { id:'ocean', name:'Deep Ocean', cost:20, preview:'linear-gradient(135deg,#60c1ff,#005b96)', css: ()=>{ const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#0ab1ff'); g.addColorStop(1,'#003a6b'); return g; } },
    { id:'retro', name:'Retro Lines', cost:30, preview:'linear-gradient(135deg,#ff66cc,#6633ff)', css: ()=>{ const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#12002b'); g.addColorStop(1,'#0a0033'); return g; } }
  ];

  lsSet(KEY.BG_BOUGHT_PREFIX + 'neon_free', 1);
  let selectedBG = lsGet(KEY.BG_SELECTED, 'neon_free') || 'neon_free';

  let audioCtx = null;
  let muted = false;
  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  function beep(freq = 440, time = 0.06, type='sine', vol=0.06){
    if(muted) return;
    ensureAudio();
    try{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = vol;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      g.gain.setTargetAtTime(0, audioCtx.currentTime + time, 0.02);
      o.stop(audioCtx.currentTime + time + 0.02);
    }catch(e){}
  }

  const paddle = {
    x: w*0.5, y: h - 60, width: 150, height: 20, speed: 1600, color:'#DDEEFF', radius:8
  };
  const ball = {
    x: w*0.5, y: h - 86, r: 10, vx:0, vy:0, speed: 520, stuck:true, color:'#ffffff'
  };
  const blocks = [];
  const coinsDropping = [];
  let levelRows = 6, levelCols = 10;
  let blocksPadding = 6;

  function rand(min,max){ return Math.random()*(max-min)+min; }
  function clamp(a,b,c){ return Math.max(b, Math.min(c, a)); }
  function rectsOverlap(a,b){
    return !(a.x+a.w < b.x || a.x > b.x+b.w || a.y+a.h < b.y || a.y > b.y+b.h);
  }

  function buildBlocks(){
    blocks.length = 0;
    const areaLeft = 60, areaRight = w - 60;
    const totalWidth = areaRight - areaLeft;
    const blockW = Math.floor((totalWidth - (levelCols-1)*blocksPadding) / levelCols);
    const blockH = 28;
    const startY = 80;
    for(let r=0;r<levelRows;r++){
      for(let c=0;c<levelCols;c++){
        const x = areaLeft + c*(blockW+blocksPadding);
        const y = startY + r*(blockH+blocksPadding);
        const hue = Math.floor(30 + (r/levelRows)*220);
        const color = `hsl(${hue}deg, 70%, ${55 - r*4}%)`;
        const points = 10 + (levelRows - r)*5;
        const hp = 1;
        blocks.push({x,y,w:blockW,h:blockH,alive:true,color,points,hp});
      }
    }
  }

  function resetRound(){
    score = 0;
    updateScore();
    buildBlocks();
    paddle.x = w*0.5;
    ball.x = w*0.5; ball.y = h - 86; ball.vx=0; ball.vy=0; ball.stuck=true;
    coinsDropping.length=0;
    gameRunning = true;
  }

  function launchBall(){
    if(!ball.stuck) return;
    ball.stuck = false;
    const angle = rand(-0.6, -1.2);
    ball.vx = Math.cos(angle) * ball.speed;
    ball.vy = Math.sin(angle) * ball.speed;
    beep(880,0.05,'square',0.07);
  }

  function addScore(v){
    score += v;
    updateScore();
    beep(520 + Math.random()*200, 0.035, 'sine', 0.04);
  }
  function updateScore(){
    scorePanel.textContent = 'Score: ' + score;
  }
  function addCoins(v, skipSave){
    coins += v;
    if(coins < 0) coins = 0;
    if(!skipSave) lsSet(KEY.COINS, coins);
    coinsPanel.textContent = coins;
    menuCoins.textContent = coins;
    shopCoins.textContent = coins;
  }
  function saveHighScoreIfNeeded(){
    const prev = lsGet(KEY.HIGHSCORE, 0)|0;
    if(score > prev){
      lsSet(KEY.HIGHSCORE, score);
      lsSet(KEY.HIGHSCORE_NAME, playerNameInput.value || playerName);
      highscore = score;
      highscorename = playerNameInput.value || playerName;
      highName.textContent = highscorename;
      menuHigh.textContent = highscore + ' (' + highscorename + ')';
      menuHighName.textContent = highscorename;
      let list = lsGet(KEY.HIGHLIST, []) || [];
      list.push({name:playerNameInput.value || playerName, score: score, ts: Date.now()});
      list.sort((a,b)=>b.score-a.score);
      if(list.length>7) list=list.slice(0,7);
      lsSet(KEY.HIGHLIST, list);
      showNewHighEffect();
    }
  }

  function showNewHighEffect(){
    const overlay = document.createElement('div');
    overlay.style.position='fixed'; overlay.style.inset=0; overlay.style.background='rgba(255,255,255,0.06)';
    overlay.style.zIndex = 9999; overlay.style.pointerEvents='none';
    document.body.appendChild(overlay);
    setTimeout(()=>document.body.removeChild(overlay), 350);
    beep(1200,0.18,'sine',0.12);
  }

  function maybeDropCoin(x,y){
    if(Math.random() < 0.25){
      coinsDropping.push({
        x:x + rand(-8,8),
        y:y + 6,
        r:12,
        vy: rand(80,180),
        vx: rand(-30,30),
        value: 1,
        ttl: 10
      });
    }
  }

  let lastT = performance.now();
  function update(now){
    const dt = Math.min(0.033, (now - lastT)/1000);
    lastT = now;

    if(!ball.stuck){
      ball.x += ball.vx * dt;
      ball.y += ball.vy * dt;

      if(ball.x - ball.r < 6){ ball.x = 6 + ball.r; ball.vx = Math.abs(ball.vx); beep(740,0.02,'sine',0.02); }
      if(ball.x + ball.r > w - 6){ ball.x = w - 6 - ball.r; ball.vx = -Math.abs(ball.vx); beep(740,0.02,'sine',0.02); }
      if(ball.y - ball.r < 6){ ball.y = 6 + ball.r; ball.vy = Math.abs(ball.vy); beep(740,0.02,'sine',0.02); }

      const pd = {x:paddle.x - paddle.width*0.5, y:paddle.y - paddle.height*0.5, w:paddle.width, h:paddle.height};
      if(ball.y + ball.r >= pd.y && ball.y - ball.r < pd.y + pd.h && ball.x > pd.x && ball.x < pd.x + pd.w && ball.vy > 0){
        const rel = (ball.x - (paddle.x)) / (paddle.width*0.5);
        const angle = rel * 1.0 - Math.PI/2;
        const speed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy) || ball.speed;
        ball.vx = Math.cos(angle) * speed;
        ball.vy = Math.sin(angle) * speed;
        ball.y = pd.y - ball.r - 0.5;
        beep(980,0.02,'square',0.06);
      }

      for(let i=0;i<blocks.length;i++){
        const b = blocks[i];
        if(!b.alive) continue;
        if(ball.x + ball.r > b.x && ball.x - ball.r < b.x + b.w && ball.y + ball.r > b.y && ball.y - ball.r < b.y + b.h){
          const overlapX = Math.min(ball.x + ball.r - b.x, b.x + b.w - (ball.x - ball.r));
          const overlapY = Math.min(ball.y + ball.r - b.y, b.y + b.h - (ball.y - ball.r));
          if(overlapX < overlapY){
            ball.vx *= -1;
            ball.x += ball.vx > 0 ? -overlapX : overlapX;
          } else {
            ball.vy *= -1;
            ball.y += ball.vy > 0 ? -overlapY : overlapY;
          }
          b.alive = false;
          addScore(b.points);
          maybeDropCoin(b.x + b.w/2, b.y + b.h/2);
          beep(640 + Math.random()*200, 0.04, 'sine', 0.05);
          break;
        }
      }

      for(let i = coinsDropping.length - 1; i >= 0; i--){
        const c = coinsDropping[i];
        c.vy += 420 * dt;
        c.x += c.vx * dt;
        c.y += c.vy * dt;
        c.ttl -= dt;
        if(c.y + c.r > paddle.y - paddle.height*0.5 && c.x > paddle.x - paddle.width*0.5 && c.x < paddle.x + paddle.width*0.5){
          addCoins(c.value);
          coinsDropping.splice(i,1);
          beep(1200 + Math.random()*400, 0.04, 'square', 0.08);
        } else if(c.y - c.r > h + 40 || c.ttl <= 0){
          coinsDropping.splice(i,1);
        }
      }

      if(ball.y - ball.r > h + 16){
        gameRunning = false;
        saveHighScoreIfNeeded();
        setTimeout(()=>{ showGameOver(); }, 400);
      }
    }else{
      ball.x = paddle.x;
      ball.y = paddle.y - 26;
    }

    if(typeof paddle.targetX === 'number'){
      const dx = paddle.targetX - paddle.x;
      paddle.x += dx * clamp(Math.abs(dx)*0.02, 0.08, 0.5);
      paddle.x = clamp(paddle.x, paddle.width*0.5 + 8, w - paddle.width*0.5 - 8);
    }

    if(gameRunning && blocks.every(b=>!b.alive)){
      levelRows = Math.min(8, levelRows + 0);
      buildBlocks();
      addCoins(3);
      ball.stuck = true;
      ball.x = paddle.x;
      ball.y = paddle.y - 26;
      beep(1600,0.1,'sine',0.09);
    }

    draw();

    requestAnimationFrame(update);
  }

  function drawBackground(){
    const bg = backgrounds.find(b=>b.id === selectedBG) || backgrounds[0];
    if(bg.id === 'neon_free'){
      ctx.fillStyle = '#000716';
      ctx.fillRect(0,0,w,h);
      ctx.save();
      const gap = 48;
      ctx.globalAlpha = 0.08;
      ctx.strokeStyle = '#00ffd5';
      ctx.lineWidth = 1;
      for(let x=0;x<w;x+=gap){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let y=0;y<h;y+=gap){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.restore();
      ctx.beginPath(); const rg = ctx.createRadialGradient(w*0.5, h*0.25, 0, w*0.5, h*0.25, 600);
      rg.addColorStop(0, 'rgba(0,255,213,0.06)'); rg.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle = rg; ctx.fillRect(0,0,w,h);
    } else {
      ctx.fillStyle = bg.css();
      ctx.fillRect(0,0,w,h);
    }
  }

  function draw(){
    drawBackground();

    for(const b of blocks){
      if(!b.alive) continue;
      ctx.fillStyle = b.color;
      roundRect(ctx, b.x, b.y, b.w, b.h, 6, true, false);
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 1;
      ctx.strokeRect(b.x+0.5,b.y+0.5,b.w-1,b.h-1);
    }

    ctx.fillStyle = '#e8f7ff';
    roundRect(ctx, paddle.x - paddle.width*0.5, paddle.y - paddle.height*0.5, paddle.width, paddle.height, paddle.radius, true, false);
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.fillRect(paddle.x - paddle.width*0.5, paddle.y + paddle.height*0.5, paddle.width, 6);

    ctx.beginPath();
    ctx.fillStyle = '#ffffff';
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    const g = ctx.createRadialGradient(ball.x, ball.y, ball.r*0.4, ball.x, ball.y, ball.r*4);
    g.addColorStop(0, 'rgba(255,255,255,0.6)'); g.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = g;
    ctx.arc(ball.x, ball.y, ball.r*4, 0, Math.PI*2);
    ctx.fill();

    for(const c of coinsDropping){
      const grd = ctx.createRadialGradient(c.x - c.r*0.3, c.y - c.r*0.3, 2, c.x, c.y, c.r);
      grd.addColorStop(0, '#fff7cd'); grd.addColorStop(1, '#ffb300');
      ctx.fillStyle = grd;
      ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.fillRect(c.x - 1, c.y - c.r*0.6, 2, c.r*0.6);
      ctx.strokeStyle = 'rgba(0,0,0,0.15)'; ctx.lineWidth = 1; ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.stroke();
    }
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    if (typeof stroke === 'undefined'){ stroke = true; }
    if (typeof r === 'undefined'){ r = 5; }
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function initInput(){
    let dragging = false;
    canvas.addEventListener('mousemove', (e)=>{
      const r = canvas.getBoundingClientRect();
      const mx = (e.clientX - r.left) * (canvas.width / r.width);
      paddle.targetX = mx;
    });
    canvas.addEventListener('mousedown', (e)=>{
      dragging=true;
      const r = canvas.getBoundingClientRect();
      const mx = (e.clientX - r.left) * (canvas.width / r.width);
      paddle.targetX = mx;
    });
    canvas.addEventListener('mouseup', ()=>{ dragging=false; });
    canvas.addEventListener('touchstart', (e)=>{
      const t = e.touches[0];
      const r = canvas.getBoundingClientRect();
      const mx = (t.clientX - r.left) * (canvas.width / r.width);
      paddle.targetX = mx;
      if(ball.stuck) { launchBall(); }
      e.preventDefault();
    }, {passive:false});
    canvas.addEventListener('touchmove', (e)=>{
      const t = e.touches[0];
      const r = canvas.getBoundingClientRect();
      const mx = (t.clientX - r.left) * (canvas.width / r.width);
      paddle.targetX = mx;
      e.preventDefault();
    }, {passive:false});
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowLeft' || e.key === 'a'){ paddle._dir = -1; }
      if(e.key === 'ArrowRight' || e.key === 'd'){ paddle._dir = 1; }
      if(e.code === 'Space'){ launchBall(); }
    });
    window.addEventListener('keyup', (e)=>{
      if(e.key === 'ArrowLeft' || e.key === 'a'){ if(paddle._dir === -1) paddle._dir = 0; }
      if(e.key === 'ArrowRight' || e.key === 'd'){ if(paddle._dir === 1) paddle._dir = 0; }
    });
    setInterval(()=>{
      if(typeof paddle._dir === 'number' && paddle._dir !== 0){
        paddle.targetX = (paddle.targetX || paddle.x) + paddle._dir * 18;
      }
    }, 16);
  }

  function openMenu(){
    overlayMenu.style.display = 'flex';
    overlayShop.style.display = 'none';
    overlayHigh.style.display = 'none';
    playerNameInput.value = playerName;
    menuCoins.textContent = coins;
    menuHigh.textContent = highscore + ' (' + highscorename + ')';
    menuHighName.textContent = highscorename;
    gameRunning = false;
  }
  function closeMenu(){
    overlayMenu.style.display = 'none';
  }

  function openShop(){
    overlayShop.style.display = 'flex';
    overlayMenu.style.display = 'none';
    overlayHigh.style.display = 'none';
    shopCoins.textContent = coins;
    renderShopList();
    gameRunning = false;
  }
  function closeShopOverlay(){
    overlayShop.style.display = 'none';
  }

  function openHigh(){
    overlayHigh.style.display = 'flex';
    overlayMenu.style.display = 'none';
    overlayShop.style.display = 'none';
    renderHighList();
    gameRunning = false;
  }
  function closeHighOverlay(){
    overlayHigh.style.display = 'none';
  }

  function isBGBought(id){
    return (lsGet(KEY.BG_BOUGHT_PREFIX + id, 0)|0) === 1;
  }
  function buyBG(id, cost){
    if(isBGBought(id)) return;
    if(coins >= cost){
      addCoins(-cost);
      lsSet(KEY.BG_BOUGHT_PREFIX + id, 1);
      lsSet(KEY.COINS, coins);
      renderShopList();
      playTinyPurchase();
    } else {
      flashShopCard(id);
    }
  }
  function selectBG(id){
    if(isBGBought(id) || id === 'neon_free'){
      selectedBG = id;
      lsSet(KEY.BG_SELECTED, id);
    }
  }

  function playTinyPurchase(){
    beep(1400,0.08,'sine',0.08);
  }

  function flashShopCard(id){
    const el = document.querySelector(`[data-bg="${id}"]`);
    if(!el) return;
    el.style.transform='translateY(-6px)';
    el.style.transition='transform .12s';
    setTimeout(()=>{ el.style.transform=''; }, 200);
    beep(240,0.06,'sawtooth',0.06);
  }

  function renderShopList(){
    shopList.innerHTML='';
    for(const b of backgrounds){
      const bought = isBGBought(b.id) || b.id === 'neon_free';
      const card = document.createElement('div'); card.className='shop-card fade-in'; card.dataset.bg = b.id;
      const preview = document.createElement('div'); preview.className='bg-preview';
      preview.style.background = b.preview || '#223';
      const name = document.createElement('div'); name.textContent = b.name; name.className='muted-sm';
      const bottom = document.createElement('div'); bottom.style.display='flex'; bottom.style.width='100%'; bottom.style.justifyContent='space-between'; bottom.style.marginTop='6px';
      const cost = document.createElement('div'); cost.className='muted-sm'; cost.textContent = b.cost ? b.cost+' coins' : 'Free';
      const actions = document.createElement('div');
      actions.style.display='flex'; actions.style.gap='6px';
      const btnUse = document.createElement('button'); btnUse.className='btn ghost'; btnUse.textContent='Use';
      const btnBuy = document.createElement('button'); btnBuy.className='btn'; btnBuy.textContent='Buy';
      if(!bought && b.cost > 0){
        actions.appendChild(btnBuy);
      } else {
        actions.appendChild(btnUse);
      }
      bottom.appendChild(cost); bottom.appendChild(actions);
      card.appendChild(preview); card.appendChild(name); card.appendChild(bottom);
      shopList.appendChild(card);

      btnBuy.addEventListener('click', ()=>{ buyBG(b.id, b.cost); });
      btnUse.addEventListener('click', ()=>{ selectBG(b.id); renderShopList(); });

      if(selectedBG === b.id){
        card.style.boxShadow = '0 6px 30px rgba(0,255,200,0.07), inset 0 1px 0 rgba(255,255,255,0.02)';
        card.style.border = '1px solid rgba(0,255,200,0.08)';
      }
    }
    shopCoins.textContent = coins;
    menuCoins.textContent = coins;
    coinsPanel.textContent = coins;
  }

  function renderHighList(){
    highList.innerHTML='';
    const list = lsGet(KEY.HIGHLIST, []) || [];
    if(list.length === 0){
      const el = document.createElement('div'); el.className='muted-sm'; el.textContent = 'No high scores yet — be the first!';
      highList.appendChild(el); return;
    }
    list.forEach(item=>{
      const row = document.createElement('div'); row.className='highscore-row';
      const n = document.createElement('div'); n.textContent = item.name;
      const s = document.createElement('div'); s.textContent = item.score;
      row.appendChild(n); row.appendChild(s);
      highList.appendChild(row);
    });
  }

  function showGameOver(){
    const prev = lsGet(KEY.HIGHSCORE, 0)|0;
    if(score > prev){
      lsSet(KEY.HIGHSCORE, score); lsSet(KEY.HIGHSCORE_NAME, playerNameInput.value || playerName);
      renderHighList();
      openHigh();
    } else {
      openMenu();
    }
  }

  btnLaunch.addEventListener('click', ()=>{ launchBall(); });
  btnMute.addEventListener('click', ()=>{
    muted = !muted;
    btnMute.textContent = muted ? 'Unmute' : 'Mute';
  });
  btnMenu.addEventListener('click', ()=> openMenu());
  btnShop.addEventListener('click', ()=> openShop());
  btnHigh.addEventListener('click', ()=> openHigh());

  menuPlay.addEventListener('click', ()=>{
    playerName = (playerNameInput.value || playerName).trim() || 'Player';
    lsSet(KEY.HIGHSCORE_NAME, playerName);
    playerNameInput.blur();
    closeMenu();
    resetRound();
  });
  menuShopBtn.addEventListener('click', ()=> openShop());
  menuHighBtn.addEventListener('click', ()=> openHigh());

  closeShop.addEventListener('click', ()=> closeShopOverlay());
  overlayShopBack.addEventListener('click', ()=> closeShopOverlay());
  closeHigh.addEventListener('click', ()=> closeHighOverlay());

  playerNameInput.addEventListener('change', ()=> {
    playerName = playerNameInput.value || playerName;
    lsSet(KEY.HIGHSCORE_NAME, playerName);
  });

  function init(){
    coins = lsGet(KEY.COINS, coins)|0;
    highscore = lsGet(KEY.HIGHSCORE, highscore)|0;
    highscorename = lsGet(KEY.HIGHSCORE_NAME, highscorename) || highscorename;
    selectedBG = lsGet(KEY.BG_SELECTED, selectedBG) || selectedBG;

    coinsPanel.textContent = coins;
    menuCoins.textContent = coins;
    shopCoins.textContent = coins;
    highName.textContent = highscorename;
    menuHigh.textContent = highscore;

    buildBlocks();
    initInput();
    lastT = performance.now();
    requestAnimationFrame(update);

    overlayMenu.style.display = 'flex';

    renderShopList();
    renderHighList();

    setTimeout(()=>{ beep(880,0.06,'sine',0.06); }, 280);
  }

  function showToast(text, time=1200){
    const t = document.createElement('div');
    t.textContent = text;
    t.style.position='fixed'; t.style.left='50%'; t.style.top='12%'; t.style.transform='translateX(-50%)';
    t.style.background='rgba(10,10,20,0.7)'; t.style.color='#fff'; t.style.padding='8px 14px'; t.style.borderRadius='14px';
    t.style.zIndex=9999; t.style.fontWeight=700; document.body.appendChild(t);
    setTimeout(()=>t.style.opacity='0', time-200);
    setTimeout(()=>{ try{ document.body.removeChild(t); }catch(e){} }, time);
  }

  init();

  window.BB = {
    resetRound, addCoins, backgrounds, lsGet, lsSet
  };

})();
</script>
</body>
</html>