<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Expert Chat </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --bg-dark: #1f1f2e;
            --bg-chat-default: #282a3a;
            --color-pink: #ec4899;
            --color-cyan: #22d3ee;
            --dark-base: #101524;
            
            --filter-color-1: var(--color-cyan);
            --filter-color-2: var(--color-pink);
            --filter-color-3: #ffffff;
            
            --mode-color-1: var(--color-cyan);
            --mode-color-2: var(--color-pink);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e5e5e5;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        .app-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(31, 31, 46, 0.95);
            border-bottom: 2px solid;
            border-image: linear-gradient(90deg, #22d3ee, #ec4899, #b500ff) 1;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 999;
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.2);
        }

        .navbar-brand-chat {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(120deg, #22d3ee, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
            text-decoration: none;
        }

        .nav-links-chat {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link-chat {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(236, 72, 153, 0.2));
            border: 2px solid rgba(34, 211, 238, 0.3);
            color: #22d3ee;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-link-chat:hover {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.4), rgba(236, 72, 153, 0.4));
            border-color: #ec4899;
            color: #ec4899;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.5);
            transform: translateY(-2px);
        }

        #app {
            margin-top: 70px;
        }
        
        .sidebar {
            width: 18rem; 
            background-color: #1a1a2e; 
            padding: 1.5rem;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .new-chat-button {
            background-color: var(--color-pink);
            color: white;
            box-shadow: 0 0 10px var(--color-pink);
            letter-spacing: 0.05em;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .model-mode-item {
            cursor: pointer;
            padding: 0.75rem 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-weight: 500;
        }

        .model-mode-item:hover {
            background-color: #33334f;
            color: var(--color-cyan);
        }

        .model-mode-item.active {
            background-color: #4f4f6e;
            color: var(--color-cyan);
            border-left: 4px solid var(--color-cyan);
            padding-left: 1rem;
        }

        #neon-indicator {
            background-color: #1a1a2e; 
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .neon-light {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 0 5px rgba(255, 255, 255, 0.1), 
                0 0 10px var(--neon-color), 
                0 0 20px var(--neon-color-strong); 
            opacity: 0.2;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #light-1 { --neon-color: var(--color-cyan); --neon-color-strong: #0ff; }
        #light-2 { --neon-color: var(--color-pink); --neon-color-strong: #f0f; }
        #light-3 { --neon-color: #ffffff; --neon-color-strong: #fff; }

        .neon-light.active {
            opacity: 0.9;
            transform: scale(1.15);
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .chat-area {
            flex-grow: 1;
            padding: 1rem 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative; 
            background-color: var(--dark-base); 
            transition: background-color 1s ease-in-out;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            z-index: 5;
        }
        
        .ai-bubble, .user-bubble, .chat-area > div:not(.bg-Code_Creator) {
            position: relative;
            z-index: 10;
        }

        .filter-flow::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1; 
            pointer-events: none;
            background-image: repeating-linear-gradient(
                45deg,
                var(--filter-color-1) 0px,
                var(--filter-color-2) 2px,
                transparent 2px,
                transparent 80px
            );
            opacity: 0.07; 
            background-size: 200% 400px;
            animation: flow-down 10s linear infinite; 
        }
        @keyframes flow-down {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 400px; }
        }

        .filter-pulse::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            pointer-events: none;
            background: 
                radial-gradient(circle at 30% 70%, var(--filter-color-1) 0%, transparent 40%),
                radial-gradient(circle at 70% 30%, var(--filter-color-2) 0%, transparent 40%);
            opacity: 0.04; 
            animation: pulse-center 4s infinite alternate ease-in-out; 
        }
        @keyframes pulse-center {
            0% { transform: scale(0.95); opacity: 0.04; }
            100% { transform: scale(1.05); opacity: 0.1; } 
        }

        .filter-wash::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            pointer-events: none;
            background-image: 
                linear-gradient(135deg, var(--filter-color-3) 0%, transparent 40%),
                linear-gradient(45deg, var(--filter-color-1) 0%, transparent 50%),
                linear-gradient(225deg, var(--filter-color-2) 0%, transparent 50%);
            opacity: 0.05;
            animation: wash-shift 15s infinite alternate ease-in-out; 
            background-size: 400% 400%; 
        }
        @keyframes wash-shift {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 100%; }
        }

        #robot-assistant {
            position: absolute;
            width: 80px;
            height: 80px;
            cursor: grab;
            user-select: none;
            z-index: 50;
            transition: box-shadow 0.3s ease;
        }

        #robot-assistant:active {
            cursor: grabbing;
        }

        .robot-bubble {
            position: absolute;
            top: -30px; 
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background-color: #1a1a2e;
            color: var(--color-cyan);
            border-radius: 8px;
            border: 1px solid var(--color-cyan);
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 60;
            box-shadow: 0 0 10px rgba(34, 211, 238, 0.8);
        }
        
        .robot-bubble::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 8px;
            height: 8px;
            background-color: #1a1a2e;
            border-right: 1px solid var(--color-cyan);
            border-bottom: 1px solid var(--color-cyan);
        }

        .robot-bubble.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }
        
        .robot-svg-glow {
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 8px var(--color-cyan));
        }

        .bg-General_Chat { 
            --mode-color-1: #ec4899; 
            --mode-color-2: #22d3ee; 
            background-image:
                radial-gradient(circle at 10% 90%, rgba(236, 72, 153, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 90% 10%, rgba(34, 211, 238, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            background-size: 150% 150%;
            animation: aurora-flow 25s infinite alternate ease-in-out;
        }

        .bg-Code_Creator { 
            --mode-color-1: #22d3ee; 
            --mode-color-2: #00ffaa;
            background-color: var(--dark-base);
            position: relative;
            background-image: none !important;
        }
        
        .bg-Code_Creator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.15; 
            pointer-events: none; 
            background-image: repeating-linear-gradient(
                0deg,
                rgba(34, 211, 238, 0.8) 0px, 
                rgba(34, 211, 238, 0.8) 1px,
                transparent 1px,
                transparent 40px 
            );
            background-size: 100% 400px;
            animation: code-fall 10s linear infinite;
        }
        
        .bg-Code_Generator_V2 {
            --mode-color-1: #6366f1;
            --mode-color-2: #38bdf8;
            background-color: var(--dark-base);
            position: relative;
            background-image: none !important;
        }

        .bg-Code_Generator_V2::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.15;
            pointer-events: none;
            background-image: repeating-linear-gradient(
                45deg,
                rgba(99, 102, 241, 0.8) 0px,
                rgba(99, 102, 241, 0.8) 1px,
                transparent 1px,
                transparent 40px
            );
            background-size: 200% 400px;
            animation: flow-down 10s linear infinite reverse;
        }

        .bg-Creative_Mode { 
            --mode-color-1: #FF00FF; 
            --mode-color-2: #00FFFF;
            background-image: linear-gradient(45deg, #FF00FF 0%, #00FFFF 50%, #FF00FF 100%);
            background-size: 200% 200%;
            animation: vaporwave-shift 10s ease infinite;
        }

        .bg-Academic_Writer { 
            --mode-color-1: #93c5fd; 
            --mode-color-2: #ffffff;
             background-image: 
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 60%),
                radial-gradient(circle at 10% 10%, rgba(255, 255, 255, 0.01) 0%, transparent 80%),
                radial-gradient(circle at 90% 90%, rgba(255, 255, 255, 0.01) 0%, transparent 80%);
            animation: aurora-flow 40s infinite alternate ease-in-out; 
        }
        
        .bg-Data_Analyst { 
            --mode-color-1: #34d399; 
            --mode-color-2: #22c55e;
            background-image: repeating-linear-gradient(
                60deg, rgba(34, 238, 34, 0.05) 0px, transparent 1px, transparent 40px),
            repeating-linear-gradient(
                -60deg, rgba(34, 238, 34, 0.05) 0px, transparent 1px, transparent 40px);
            background-size: 150% 150%;
            animation: prog-flow 12s linear infinite reverse;
        }

        .bg-Technical_Support { 
            --mode-color-1: #22d3ee; 
            --mode-color-2: #fbbf24;
            background-color: var(--dark-base);
            position: relative;
            overflow: hidden;
        }
        
        .bg-Marketing_Strategist { 
            --mode-color-1: #facc15; 
            --mode-color-2: #f472b6;
            background-color: var(--dark-base);
            position: relative;
            box-shadow: 0 0 0px var(--dark-base) inset;
            animation: color-pulse 4s infinite alternate;
            --pulse-color: #fbbf24;
        }

        .bg-Financial_Advisor { 
            --mode-color-1: #84cc16; 
            --mode-color-2: #fde047;
            background-image: 
                radial-gradient(circle at 70% 30%, rgba(132, 204, 22, 0.1) 0%, transparent 50%),
                repeating-linear-gradient(
                    0deg, rgba(255, 255, 0, 0.03) 0, rgba(255, 255, 0, 0.05) 1px, transparent 1px, transparent 10px);
            background-size: 100% 100%, 100% 20px;
            animation: prog-flow 25s linear infinite;
        }

        .bg-Legal_Assistant { 
            --mode-color-1: #ef4444; 
            --mode-color-2: #9333ea;
            background-color: var(--dark-base);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 0px var(--dark-base) inset;
            animation: color-pulse 6s infinite alternate;
            --pulse-color: #ef4444;
        }
        
        .bg-Storyteller { 
            --mode-color-1: #a855f7; 
            --mode-color-2: #ec4899;
             background-image: 
                radial-gradient(circle at 15% 85%, rgba(236, 72, 153, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 85% 15%, rgba(168, 85, 247, 0.2) 0%, transparent 40%), 
                repeating-radial-gradient(
                    circle at center, rgba(255, 255, 255, 0.01) 0px, rgba(255, 255, 255, 0.03) 1px, transparent 200px);
            background-size: 100% 100%, 100% 100%, 150% 150%;
            animation: aurora-flow 35s infinite alternate ease-in-out reverse;
        }
        
        .bg-Filipino_Translator { 
            --mode-color-1: #3b82f6; 
            --mode-color-2: #f59e0b;
            background-color: var(--dark-base);
            position: relative;
            box-shadow: 0 0 0px var(--dark-base) inset;
            animation: color-pulse 5s infinite alternate;
            --pulse-color: #fca5a5; 
        }
        
        @keyframes code-fall {
            0% { background-position-y: 0; }
            100% { background-position-y: 400px; }
        }
        @keyframes aurora-flow {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }
        @keyframes color-pulse {
            0% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.1); }
            50% { box-shadow: 0 0 20px var(--pulse-color); }
            100% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.1); }
        }
        @keyframes vaporwave-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .input-area {
            flex-shrink: 0;
            background-color: #1a1a2e;
            padding: 1rem 0;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 15;
        }
        
        .input-box {
            background-color: #282a3a;
            border: 2px solid #4a4a6e;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.1);
        }

        textarea {
            background-color: transparent !important;
            color: white !important;
            min-height: 2.5rem;
            max-height: 10rem;
            line-height: 1.5;
            padding: 0.5rem 0.75rem;
        }
        
        .send-button {
            background-color: #4a4a6e;
            color: #a0aec0;
            padding: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 5px rgba(236, 72, 153, 0.3);
        }

        .send-button:not(:disabled) {
            background: linear-gradient(135deg, var(--color-pink) 0%, var(--color-cyan) 100%);
            color: white;
            box-shadow: 0 0 10px var(--color-cyan), 0 0 20px var(--color-pink);
        }
        
        .send-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .stop-button-style {
            background-color: #ef4444;
            box-shadow: 0 0 10px #ef4444;
            color: white;
        }
    </style>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth;
        let userId = null;
        let currentMode = 'General_Chat';
        let currentChatId = null; 
        let isWaitingForResponse = false;
        let showAiThoughts = false;
        let abortController = null;
        let currentNeonMode = 1;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const API_KEY = "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";
        const OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";
        const OPENAI_MODEL = "gpt-4o-mini";

        let chatHistory = [];
        const GEMINI_TEXT_MODEL = OPENAI_MODEL;
        const IMAGEN_MODEL = "gpt-image-1";

        const modeDisplayNameMap = {
            'General_Chat': 'General Chat',
            'Code_Creator': 'Code Creator',
            'Code_Generator_V2': 'Code Generator V2',
            'Creative_Mode': 'Creative Mode (Image Gen)',
            'Academic_Writer': 'Academic Writer',
            'Data_Analyst': 'Data Analyst',
            'Technical_Support': 'Technical Support',
            'Marketing_Strategist': 'Marketing Strategist',
            'Financial_Advisor': 'Financial Advisor',
            'Legal_Assistant': 'Legal Assistant',
            'Storyteller': 'Storyteller',
            'Filipino_Translator': 'Filipino Translator'
        };

        const modeSystemInstructionMap = {
            'General_Chat': 'You are a friendly, multilingual general assistant. Your responses should be helpful, concise, and professional. Use Cebuano (Bisaya) or English as appropriate for the user\'s query, but primarily use Cebuano if the user types in Cebuano.',
            'Code_Creator': 'You are a world-class software engineer. Respond only with complete, runnable code examples or clear, step-by-step programming advice. Explain the code clearly.',
            'Code_Generator_V2': 'Ikaw usa ka high-performance nga code generator. Kinahanglan nimo nga sundon ang matag usa nga mando sa tiggamit nga eksakto. Pag-output lamang sa kumpleto, runnable code base sa ilang gipangayo. Ayaw paghatag ug bisan unsang pagpatin-aw o dugang nga teksto gawas kung gihangyo gyud. (You are a high-performance code generator. You must follow every user command exactly. Output only complete, runnable code based on their request. Do not provide any explanation or extra text unless specifically requested.)',
            'Creative_Mode': 'You are an expert image prompt engineer. Your task is to generate one visually stunning, high-quality image based on the user\'s request. Automatically enhance the user\'s prompt with details on style, lighting, and composition to maximize visual impact. You MUST respond ONLY with the enhanced prompt text, nothing else.',
            'Academic_Writer': 'You are a meticulous academic research assistant. Provide well-structured, evidence-based responses suitable for university-level work. Cite sources when asked to find real-time information.',
            'Data_Analyst': 'You are a skilled data science expert. Analyze data descriptions, explain statistical concepts, and provide Python/Pandas or R code snippets for data manipulation and visualization.',
            'Technical_Support': 'You are a patient and knowledgeable IT support specialist. Troubleshoot common technical problems, providing simple, step-by-step instructions in a calm and encouraging tone.',
            'Marketing_Strategist': 'You are a creative and results-driven marketing strategist. Generate innovative campaign ideas, analyze target audiences, and suggest copy that drives engagement and conversion.',
            'Financial_Advisor': 'You are a licensed and cautious financial advisor. Offer conservative, educational advice on personal finance, investment basics, and budgeting. Always include a strong disclaimer about consulting a real professional for major decisions.',
            'Legal_Assistant': 'You are a detailed legal assistant specializing in basic legal concepts. Provide summaries of laws and procedures, but strictly advise the user that your information is NOT legal advice and they MUST consult an attorney.',
            'Storyteller': 'You are an imaginative and engaging storyteller and poet. Create narrative and descriptive text based on the user\'s theme, using rich vocabulary and compelling imagery.',
            'Filipino_Translator': 'You are an expert, fluent Filipino (Tagalog) and Cebuano (Bisaya) translator. Your primary function is accurate translation between English, Filipino, and Cebuano. Use Cebuano when translating to or from a Cebuano input.'
        };
        
        async function fetchWithRetry(url, options, maxRetries = 5, signal = null) {
             if (signal) {
                 options.signal = signal;
             }
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status >= 500 || response.status === 429) {
                        throw new Error(`Transient API error: Status ${response.status}`);
                    } else {
                        const errorBody = await response.text();
                        throw new Error(`Non-retriable API error: Status ${response.status}. Body: ${errorBody}`);
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw error; 
                    }
                    console.error(`Fetch attempt ${i + 1} failed:`, error.message);
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function displaySystemMessage(message, isError = false) {
            const chatArea = document.getElementById('chat-area');
            const messageEl = document.createElement('div');
            messageEl.className = `p-3 rounded-xl mx-2 my-2 text-sm max-w-lg ${isError ? 'bg-red-900 text-red-200' : 'bg-pink-900 text-pink-200'} self-start relative z-10`;
            messageEl.textContent = message;
            chatArea.appendChild(messageEl);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function displayError(message) {
            displaySystemMessage(`CRITICAL ERROR: ${message}`, true);
        }

        function getSystemInstruction(modeId) {
            return modeSystemInstructionMap[modeId] || modeSystemInstructionMap['General_Chat'];
        }
        
        function createMessageElement(text, role, sources = [], thought = null) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex my-3 ${role === 'user' ? 'justify-end' : 'justify-start'} relative z-10`; 

            const bubble = document.createElement('div');
            bubble.className = `p-4 rounded-xl max-w-3xl shadow-lg transform transition-all duration-300 ${role === 'user'
                ? 'bg-cyan-700 text-white user-bubble rounded-br-none'
                : 'bg-gray-800 text-gray-100 ai-bubble rounded-tl-none'
            }`;

            if (thought && role === 'ai') {
                const thoughtEl = document.createElement('div');
                thoughtEl.className = 'ai-thought text-xs italic mb-2 p-1 rounded bg-gray-700 text-gray-400';
                thoughtEl.textContent = thought;
                bubble.appendChild(thoughtEl);
            }
            
            const textEl = document.createElement('p');
            textEl.className = 'whitespace-pre-wrap';
            textEl.textContent = text;
            bubble.appendChild(textEl);

            if (sources && sources.length > 0) {
                const sourcesEl = document.createElement('div');
                sourcesEl.className = 'text-xs mt-2 pt-2 border-t border-gray-600 text-gray-400';
                sourcesEl.innerHTML = '<strong>Sources:</strong><ul class="list-disc list-inside mt-1">';
                sources.forEach(source => {
                    sourcesEl.innerHTML += `<li><a href="${source.uri}" target="_blank" class="text-pink-400 hover:text-pink-200 transition">${source.title || source.uri}</a></li>`;
                });
                sourcesEl.innerHTML += '</ul>';
                bubble.appendChild(sourcesEl);
            }

            messageContainer.appendChild(bubble);
            return messageContainer;
        }

        let unsubscribeFirestore = null;

        async function createNewChat() {
            if (unsubscribeFirestore) {
                unsubscribeFirestore(); 
            }
            document.getElementById('chat-area').innerHTML = ''; 
            currentChatId = Date.now().toString(); 
            
            displaySystemMessage(`Nagsugod og bag-ong chat session sa ${modeDisplayNameMap[currentMode]} mode. Ang kasaysayan sa chat ma-save ubos sa ${currentChatId}.`);
            
            await loadChatHistoryFromFirestore(currentChatId);
        }

        async function loadChatHistoryFromFirestore(chatId) {
            const chatArea = document.getElementById('chat-area');
            chatArea.innerHTML = '';

            if (!db || !userId) {
                const local = loadLocalHistory();
                if (local && local.length > 0) {
                    local.forEach(entry => {
                        const text = entry.parts && entry.parts[0] ? entry.parts[0].text : '';
                        const role = entry.role === 'user' ? 'user' : 'ai';
                        chatArea.appendChild(createMessageElement(text, role));
                    });
                    chatArea.scrollTop = chatArea.scrollHeight;
                    checkInput();
                    return;
                }
                displaySystemMessage(`Kumusta! Andam na ang ${modeDisplayNameMap[currentMode]} mode!`, true);
                return;
            }
            
            const chatRef = collection(db, 'artifacts', appId, 'users', userId, 'chats', chatId, 'messages');
            const q = query(chatRef, orderBy('timestamp'));

            if (unsubscribeFirestore) {
                unsubscribeFirestore();
            }
            
            unsubscribeFirestore = onSnapshot(q, (snapshot) => {
                chatArea.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const text = data.text || "Message content not available.";
                    const role = data.role === 'user' ? 'user' : 'ai';
                    
                    chatArea.appendChild(createMessageElement(text, role));
                });
                chatArea.scrollTop = chatArea.scrollHeight;
                
                if (snapshot.docs.length === 0) {
                    const local = loadLocalHistory();
                    if (local && local.length > 0) {
                        local.forEach(entry => {
                            const text = entry.parts && entry.parts[0] ? entry.parts[0].text : '';
                            const role = entry.role === 'user' ? 'user' : 'ai';
                            chatArea.appendChild(createMessageElement(text, role));
                        });
                        chatArea.scrollTop = chatArea.scrollHeight;
                    } else {
                        displaySystemMessage(`Kumusta! Andam na ang ${modeDisplayNameMap[currentMode]} mode!`);
                    }
                }
                
                checkInput();
            }, (error) => {
                console.error("Error listening to messages:", error);
                displaySystemMessage("Error sa pag-load sa kasaysayan sa chat.", true);
            });
        }

        async function getChatHistory() {
            if (!db || !userId || !currentChatId) {
                return loadLocalHistory();
            }

            const messagesRef = collection(db, 'artifacts', appId, 'users', userId, 'chats', currentChatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));
            
            const snapshot = await getDocs(q);
            
            const history = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    role: data.role === 'user' ? 'user' : 'model',
                    parts: [{ text: data.text }]
                };
            });
            return history.slice(-10);
        }

        const LOCAL_HISTORY_PREFIX = 'gexpert_local_history_';

        function _localHistoryKey() {
            const uid = userId || 'local';
            const cid = currentChatId || 'default';
            return `${LOCAL_HISTORY_PREFIX}${appId || 'app'}_${uid}_${cid}`;
        }

        function loadLocalHistory() {
            try {
                const key = _localHistoryKey();
                const raw = localStorage.getItem(key);
                if (!raw) return [];
                const arr = JSON.parse(raw);
                return arr.map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.text || '' }] })).slice(-20);
            } catch (e) {
                console.warn('Failed to load local history', e);
                return [];
            }
        }

        function saveMessageLocal(text, role) {
            try {
                const key = _localHistoryKey();
                const raw = localStorage.getItem(key);
                const arr = raw ? JSON.parse(raw) : [];
                arr.push({ role: role === 'user' ? 'user' : 'model', text: text, ts: Date.now() });
                const trimmed = arr.slice(-20);
                localStorage.setItem(key, JSON.stringify(trimmed));
            } catch (e) {
                console.warn('Failed to save local message', e);
            }
        }

        function clearLocalHistory() {
            try {
                const key = _localHistoryKey();
                localStorage.removeItem(key);
            } catch (e) {
                console.warn('Failed to clear local history', e);
            }
        }

        function detectLanguage(text) {
            if (!text || typeof text !== 'string') return 'en';
            const s = text.trim();
            if (/[\u3040-\u30ff\u4e00-\u9fff]/.test(s)) return 'ja/zh';
            if (/[\uac00-\ud7af]/.test(s)) return 'ko';
            if (/[\u4e00-\u9fff]/.test(s)) return 'zh';
            const cebWords = ['unsa', 'palihug', 'ako', 'akoang', 'paborito', 'pula', 'gusto'];
            const tagWords = ['ano', 'paborito', 'kulay', 'ako', 'ako ang', 'gusto'];
            const low = s.toLowerCase();
            for (const w of cebWords) if (low.includes(w)) return 'ceb';
            for (const w of tagWords) if (low.includes(w)) return 'tl';
            return 'en';
        }

        function _memoryKey() {
            const uid = userId || 'local';
            const cid = currentChatId || 'default';
            return `gexpert_memory_${appId || 'app'}_${uid}_${cid}`;
        }

        function saveMemoryFact(key, value) {
            try {
                const memKey = _memoryKey();
                const raw = localStorage.getItem(memKey);
                const obj = raw ? JSON.parse(raw) : {};
                obj[key] = { value: value, ts: Date.now() };
                localStorage.setItem(memKey, JSON.stringify(obj));
            } catch (e) {
                console.warn('Failed to save memory fact', e);
            }
        }

        function loadMemoryFact(key) {
            try {
                const memKey = _memoryKey();
                const raw = localStorage.getItem(memKey);
                if (!raw) return null;
                const obj = JSON.parse(raw);
                return obj[key] ? obj[key].value : null;
            } catch (e) {
                console.warn('Failed to load memory fact', e);
                return null;
            }
        }

        function extractFactsFromPrompt(text) {
            if (!text) return {};
            const facts = {};
            const low = text.toLowerCase();

            let m = low.match(/(?:my\s+)?favorite\s+colou?r\s*(?:is|:)?\s*([a-z\-\s]+)/i);
            if (m && m[1]) {
                facts.favorite_color = m[1].trim().split(/[\s,\.\!\?]+/)[0];
                return facts;
            }

            m = low.match(/(?:akoang|ang\s+akong|ako\s+ang)?\s*(?:paborito|paboritong)\s*(?:kolor|kulay)\s*(?:mao\s+ang|is|:)?\s*([^\n\.!\?]+)/i);
            if (m && m[1]) {
                facts.favorite_color = m[1].trim().split(/[\s,\.\!\?]+/)[0];
                return facts;
            }

            m = low.match(/(?:favorite|paborito|paboritong)\s*(?:is|:)?\s*([a-z\-\s]+)/i);
            if (m && m[1]) {
                facts.favorite_color = m[1].trim().split(/[\s,\.\!\?]+/)[0];
                return facts;
            }

            return facts;
        }

        function isMemoryQuery(text) {
            if (!text) return false;
            const low = text.toLowerCase();
            const patterns = [
                /what\s+is\s+my\s+favorite\s+colou?r/i,
                /what\s+is\s+my\s+favorite/i,
                /unsa\s+gani\s+(?:ang\s+)?(?:imong|akoang|ang)\s+paborito/i,
                /unsa\s+ang\s+imong\s+paborito\s+kolor/i,
                /unsa\s+ang\s+akoang\s+paborito/i,
                /ano\s+ang\s+paborito\s+mo(ng|n)?\s*(?:kulay|kolor)?/i,
                /paborito\s+kolor\s*\?/i
            ];
            return patterns.some(rx => rx.test(low));
        }

        function respondFromMemoryForFavoriteColor(lang) {
            const color = loadMemoryFact('favorite_color');
            if (!color) return null;
            const c = color;
            const templates = {
                en: `Your favorite color is ${c}.`,
                ceb: `Ang imong paboritong kolor mao ang ${c}.`,
                tl: `Ang paborito mong kulay ay ${c}.`,
                'ja/zh': `„ÅÇ„Å™„Åü„ÅÆÂ•Ω„Åç„Å™Ëâ≤„ÅØ ${c} „Åß„Åô„ÄÇ`,
                zh: `‰Ω†ÊúÄÂñúÊ¨¢ÁöÑÈ¢úËâ≤ÊòØ ${c}„ÄÇ`,
                ko: `ÎãπÏã†Ïù¥ Í∞ÄÏû• Ï¢ãÏïÑÌïòÎäî ÏÉâÏùÄ ${c}ÏûÖÎãàÎã§.`
            };
            return templates[lang] || templates['en'];
        }

        function analyzeConversationContext(userPrompt, historyMessages) {
            const lang = detectLanguage(userPrompt || '');
            const toneHints = [];
            const low = (userPrompt || '').toLowerCase();
            if (low.includes('please') || low.includes('palihug')) toneHints.push('polite');
            if (low.includes('help') || low.includes('tabang')) toneHints.push('helpful');
            if ((userPrompt || '').length < 40) toneHints.push('concise');

            const recentOpenings = new Set();
            (historyMessages || []).slice(-6).forEach(m => {
                const text = m.parts && m.parts[0] ? (m.parts[0].text || '') : '';
                if (m.role === 'model' || m.role === 'assistant' || m.role === 'ai') {
                    const firstLine = (text || '').split(/[\.\!\?\n]/)[0].trim().toLowerCase();
                    if (firstLine) recentOpenings.add(firstLine);
                }
            });

            return { lang, toneHints, recentOpenings };
        }

        function generateSmartSystemInstruction(baseInstruction, context) {
            const avoid = Array.from(context.recentOpenings || []).slice(0,5).map(s => `"${s}"`).join(', ');
            let extra = 'Be concise and avoid repetitive or generic openings. Use a natural, bright, and helpful tone. Vary your opening phrases and avoid starting responses with the same short phrases repeatedly.';
            if (avoid) {
                extra += ` Do NOT start responses with the following recent openings: ${avoid}.`;
            }
            if (context.lang && context.lang !== 'en') {
                extra += ` Prefer responding in ${context.lang === 'ceb' ? 'Cebuano' : context.lang === 'tl' ? 'Tagalog' : context.lang === 'ja/zh' ? 'Japanese/Chinese' : context.lang === 'ko' ? 'Korean' : 'the user\'s language'}.`;
            }
            return `${extra}\n\nSystem: ${baseInstruction}`;
        }

        function postProcessAIReply(text, context) {
            if (!text || typeof text !== 'string') return text;
            let t = text.trim();
            const genericPatterns = [/^maayo[\.!\s,-]*/i, /^nakita nako[\.!\s,-]*/i, /^sure[\.!\s,-]*/i, /^okay[\.!\s,-]*/i, /^i\'m sorry[\.!\s,-]*/i, /^pasensya na[\.!\s,-]*/i];
            for (const rx of genericPatterns) {
                if (rx.test(t)) {
                    t = t.replace(rx, '').trim();
                }
            }

            const openings = {
                en: ['Got it ‚Äî', 'Noted ‚Äî', 'Here you go:', 'Thanks ‚Äî'],
                ceb: ['Sige ‚Äî', 'Nakuha na ‚Äî', 'Ani na ‚Äî'],
                tl: ['Sige ‚Äî', 'Tandaan ko ‚Äî', 'Hetong sagot ‚Äî']
            };
            const lang = context && context.lang ? context.lang : 'en';
            const openerList = openings[lang] || openings['en'];

            const wasGeneric = genericPatterns.some(rx => rx.test(text));
            if (wasGeneric) {
                const choice = openerList[Math.floor(Math.random() * openerList.length)];
                t = `${choice} ${t}`.trim();
            }

            if (!t) return text;
            return t;
        }

        async function saveMessage(text, role) {
            try {
                saveMessageLocal(text, role);
            } catch (e) {
                console.warn('Local save failed:', e);
            }

            if (!db || !userId || !currentChatId) {
                console.warn("Firestore not ready or missing chat ID. Saved locally only.");
                return;
            }
            
            const messagesRef = collection(db, 'artifacts', appId, 'users', userId, 'chats', currentChatId, 'messages');
            
            try {
                await addDoc(messagesRef, {
                    text: text,
                    role: role,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Error saving message to Firestore:", e);
            }
        }
        
        function getApiKey() {
            try {
                const k = localStorage.getItem('gexpert_api_key');
                if (k && k.trim()) return k.trim();
            } catch (e) {
                console.warn('localStorage unavailable for API key read', e);
            }
            try {
                const meta = document.querySelector('meta[name="gexpert-api-key"]');
                if (meta && meta.content && meta.content.trim()) return meta.content.trim();
            } catch (e) { }
            try {
                const el = document.getElementById('embedded-api-key');
                if (el) {
                    const v = (el.value || el.textContent || '').toString().trim();
                    if (v) return v;
                }
            } catch (e) { }
            return null;
        }

        function detectApiKeySource() {
            try {
                const fromLocal = localStorage.getItem('gexpert_api_key');
                if (fromLocal && fromLocal.trim()) return { source: 'localStorage', value: maskKey(fromLocal) };
            } catch (e) { }
            try {
                const meta = document.querySelector('meta[name="gexpert-api-key"]');
                if (meta && meta.content && meta.content.trim()) return { source: 'meta', value: maskKey(meta.content) };
            } catch (e) { }
            try {
                const el = document.getElementById('embedded-api-key');
                if (el) {
                    const v = (el.value || el.textContent || '').toString().trim();
                    if (v) return { source: 'embedded-element', value: maskKey(v) };
                }
            } catch (e) { }
            return { source: 'none', value: null };
        }

        function maskKey(k) {
            if (!k || k.length < 8) return '*****';
            return k.slice(0,4) + '...' + k.slice(-4);
        }

        function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            const apiKeyInput = document.getElementById('api-key-input');
            const currentKey = getApiKey();
            
            modal.classList.remove('hidden');
            
            if (currentKey) {
                apiKeyInput.value = currentKey;
            } else {
                apiKeyInput.value = '';
            }
            
            apiKeyInput.focus();
            apiKeyInput.select();
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('hidden');
        }

        function updateSettingsStatus(message, isError = false) {
            const statusEl = document.getElementById('settings-status');
            statusEl.textContent = message;
            statusEl.className = `mb-6 p-3 rounded-lg text-sm min-h-12 flex items-center transition duration-300 ${
                isError 
                    ? 'bg-red-900 text-red-200' 
                    : 'bg-green-900 text-green-200'
            }`;
        }

        async function testApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            const key = apiKeyInput.value.trim();
            
            if (!key) {
                updateSettingsStatus('‚ùå API key field is empty', true);
                return;
            }

            updateSettingsStatus('üîç Testing API key...');
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${key}`
                    }
                });

                if (response.ok) {
                    updateSettingsStatus('‚úÖ API key is valid! Ready to use.');
                } else if (response.status === 401) {
                    updateSettingsStatus('‚ùå API key is invalid or expired', true);
                } else if (response.status === 429) {
                    updateSettingsStatus('‚ùå Rate limited. Try again later.', true);
                } else {
                    updateSettingsStatus(`‚ùå Error: HTTP ${response.status}`, true);
                }
            } catch (error) {
                updateSettingsStatus('‚ùå Network error: ' + error.message, true);
            }
        }

        function saveApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            const key = apiKeyInput.value.trim();
            
            if (!key) {
                updateSettingsStatus('‚ùå API key field is empty', true);
                return;
            }

            try {
                localStorage.setItem('gexpert_api_key', key);
                updateSettingsStatus(`‚úÖ API key saved! (${maskKey(key)})`);
            } catch (error) {
                updateSettingsStatus('‚ùå Failed to save API key: ' + error.message, true);
            }
        }

        function clearApiKey() {
            if (!confirm('Are you sure? This will clear your saved API key.')) {
                return;
            }

            try {
                localStorage.removeItem('gexpert_api_key');
                document.getElementById('api-key-input').value = '';
                updateSettingsStatus('üóëÔ∏è API key cleared');
            } catch (error) {
                updateSettingsStatus('‚ùå Failed to clear API key: ' + error.message, true);
            }
        }

        async function pasteAndTest() {
            try {
                const text = await navigator.clipboard.readText();
                const apiKeyInput = document.getElementById('api-key-input');
                apiKeyInput.value = text.trim();
                
                setTimeout(() => {
                    testApiKey();
                }, 300);
            } catch (error) {
                updateSettingsStatus('‚ùå Could not read clipboard: ' + error.message, true);
            }
        }

        async function callOpenAIAPI(messages, isImageGen = false, signal = null) {
            const apiKey = getApiKey();
            if (!apiKey) {
                const err = new Error('Missing OpenAI API key. Open Settings and paste your key into the API Key field.');
                err.name = 'MissingAPIKey';
                throw err;
            }

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({ model: OPENAI_MODEL, messages: messages })
            };
            if (signal) options.signal = signal;

            let response;
            try {
                response = await fetchWithRetry(OPENAI_API_URL, options, 3, signal);
            } catch (err) {
                console.error('OpenAI fetchWithRetry failed:', err);
                throw new Error('Network request failed: ' + (err.message || String(err)));
            }

            if (!response.ok) {
                const status = response.status;
                const statusText = response.statusText || '';
                let body = null;
                try { body = await response.text(); } catch (e) { body = null; }
                const msg = `API call failed: ${status} ${statusText}. Body: ${body ? body.substring(0,500) : '<no body>'}`;
                const err = new Error(msg);
                err.raw = { status, statusText, body };
                throw err;
            }

            let data;
            try {
                data = await response.json();
            } catch (err) {
                const txt = await response.text().catch(() => null);
                throw new Error('Failed to parse API response as JSON: ' + (txt ? txt.substring(0,500) : err.message));
            }

            console.debug('OpenAI raw response:', data);

            let text = 'Walay reply gikan sa AI.';
            if (data.choices && data.choices.length > 0) {
                text = data.choices[0].message?.content || data.choices[0].text || text;
            }

            let base64Image = null;
            if (isImageGen && data.data && data.data[0] && data.data[0].b64_json) {
                base64Image = data.data[0].b64_json;
            }

            return { text, base64Image, thought: 'AI Thought: Response received successfully.', raw: data };
        }

        function updateChatAreaFilter(neonMode) {
            const chatArea = document.getElementById('chat-area');
            const lights = document.querySelectorAll('.neon-light');
            
            ['filter-flow', 'filter-pulse', 'filter-wash'].forEach(c => chatArea.classList.remove(c));
            
            lights.forEach(light => light.classList.remove('active'));
            
            const activeLight = document.getElementById(`light-${neonMode}`);
            if (!activeLight) return;

            const filterMap = { 1: 'flow', 2: 'pulse', 3: 'wash' };
            const filterClass = `filter-${filterMap[neonMode]}`;
            
            chatArea.classList.add(filterClass);
            activeLight.classList.add('active');
            currentNeonMode = neonMode;
            
            const style = getComputedStyle(chatArea);
            const modeColor1 = style.getPropertyValue('--mode-color-1').trim() || '#ec4899';
            const modeColor2 = style.getPropertyValue('--mode-color-2').trim() || '#22d3ee';
            
            chatArea.style.setProperty('--filter-color-1', modeColor1);
            chatArea.style.setProperty('--filter-color-2', modeColor2);
            chatArea.style.setProperty('--filter-color-3', '#ffffff'); 
            
            displaySystemMessage(`Ang Neon Filter gi-ilisdan ngadto sa Mode ${neonMode} (${filterMap[neonMode]}).`);
        }

        function handleNeonIndicatorClick(neonMode) {
            updateChatAreaFilter(neonMode);
        }

        function setMode(modeId) {
            currentMode = modeId;
            const displayName = modeDisplayNameMap[modeId] || modeId.replace(/_/g, ' ');

            document.querySelectorAll('.model-mode-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`mode-${modeId}`).classList.add('active');

            document.getElementById('current-mode-display').textContent = displayName;
            
            const chatArea = document.getElementById('chat-area');
            
            chatArea.className = 'chat-area';
            
            chatArea.classList.add(`bg-${modeId}`);
            
            const uploadBtn = document.getElementById('upload-image-btn');
            const hint = document.getElementById('input-hint');
            const input = document.getElementById('prompt-input');
            
            if (modeId === 'Creative_Mode') {
                uploadBtn.classList.add('hidden');
                input.placeholder = 'Describe the image you want to create (e.g., "A futuristic cityscape with flying cars")...';
                hint.textContent = 'Creative Mode: Only text description needed for Image Generation.';
            } else {
                uploadBtn.classList.remove('hidden');
                input.placeholder = 'Type your message or image description...';
                hint.textContent = 'Multimodal Chat: Ask questions or upload an image. The AI is an expert in this field.';
            }
            
            updateChatAreaFilter(currentNeonMode);
            
            checkInput();
            createNewChat();
        }
        
        function handleShowAiThoughtsToggle() {
            showAiThoughts = !showAiThoughts;
            const button = document.getElementById('toggle-ai-thoughts');
            button.textContent = showAiThoughts ? 'Hide AI Thoughts' : 'Show AI Thoughts';
            button.classList.toggle('bg-gray-800', !showAiThoughts);
            button.classList.toggle('bg-pink-900', showAiThoughts);
            button.classList.toggle('text-gray-400', !showAiThoughts);
            button.classList.toggle('text-pink-300', showAiThoughts);
            
            const chatArea = document.getElementById('chat-area');
            const bubbles = chatArea.querySelectorAll('.ai-bubble');
            bubbles.forEach(bubble => {
                let thoughtEl = bubble.querySelector('.ai-thought');
                if (thoughtEl) {
                    thoughtEl.style.display = showAiThoughts ? 'block' : 'none';
                }
            });
        }
        
        function getBase64Image(file) {
            return new Promise((resolve, reject) => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => resolve({
                        data: reader.result.split(',')[1],
                        mimeType: file.type
                    });
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                } else {
                    resolve(null);
                }
            });
        }
        
        window.stopTyping = () => {
            if (abortController) {
                abortController.abort();
            }
        };

        async function sendMessage() {
            if (isWaitingForResponse) {
                displaySystemMessage("Palihug paghulat. Nag-generate pa ang AI sa miaging command.", true);
                return;
            }

            const promptInput = document.getElementById('prompt-input');
            const fileInput = document.getElementById('file-upload');
            const userPrompt = promptInput.value.trim();
            const file = fileInput.files[0];

            if (!userPrompt && !file) {
                displaySystemMessage("Palihug pag-type og message o pag-upload og hulagway.", true);
                return;
            }

            isWaitingForResponse = true;
            document.getElementById('send-button').disabled = true;
            document.getElementById('stop-button').classList.remove('hidden');
            
            let base64Image = null;
            let mimeType = null;
            
            if (file) {
                try {
                    const imageInfo = await getBase64Image(file);
                    base64Image = imageInfo.data;
                    mimeType = imageInfo.mimeType;
                } catch (e) {
                    displaySystemMessage("Dili makabasa sa file. Palihug i-check ang format sa hulagway.", true);
                    resetInputState();
                    return;
                }
            }

            const chatArea = document.getElementById('chat-area');
            const userMessageText = userPrompt + (file ? ` [Hulagway: ${file.name}]` : '');
            
            const userMessageContainer = createMessageElement(userMessageText, 'user');
            const userBubble = userMessageContainer.querySelector('.user-bubble');

            if (base64Image && mimeType && userBubble) {
                const imageUrl = `data:${mimeType};base64,${base64Image}`;
                const imageEl = document.createElement('img');
                imageEl.src = imageUrl;
                imageEl.alt = userPrompt || 'Uploaded image';
                imageEl.className = 'mt-2 rounded-lg max-w-full h-auto shadow-xl border border-cyan-400 shadow-cyan-500/50'; 
                
                const textEl = userBubble.querySelector('p');
                userBubble.insertBefore(imageEl, textEl);
            }

            chatArea.appendChild(userMessageContainer);
            chatArea.scrollTop = chatArea.scrollHeight;
            await saveMessage(userMessageText, 'user');

            try {
                const facts = extractFactsFromPrompt(userPrompt);
                if (facts.favorite_color) {
                    saveMemoryFact('favorite_color', facts.favorite_color);
                    const lang = detectLanguage(userPrompt);
                    const confirmMsgs = {
                        en: `Got it ‚Äî I'll remember that your favorite color is ${facts.favorite_color}.`,
                        ceb: `Sakto! Hinumduman nako nga ang imong paborito nga kolor kay ${facts.favorite_color}.`,
                        tl: `Noted! Tandaan ko na ang paborito mong kulay ay ${facts.favorite_color}.`,
                        'ja/zh': `‰∫ÜËß£„Åó„Åæ„Åó„Åü„ÄÇ„ÅÇ„Å™„Åü„ÅÆÂ•Ω„Åç„Å™Ëâ≤„ÅØ ${facts.favorite_color} „Å®Ë¶ö„Åà„Åæ„Åô„ÄÇ`,
                        zh: `Â•ΩÁöÑÔºåÊàëÊúÉË®ò‰Ωè‰Ω†ÂñúÊ≠°ÁöÑÈ°èËâ≤ÊòØ ${facts.favorite_color}„ÄÇ`,
                        ko: `ÏïåÍ≤†ÏäµÎãàÎã§. ÎãπÏã†Ïù¥ Ï¢ãÏïÑÌïòÎäî ÏÉâÏùÄ ${facts.favorite_color}Î°ú Í∏∞ÏñµÌïòÍ≤†ÏäµÎãàÎã§.`
                    };
                    displaySystemMessage(confirmMsgs[lang] || confirmMsgs['en']);
                }
            } catch (e) {
                console.warn('Fact extraction failed', e);
            }

            try {
                if (isMemoryQuery(userPrompt)) {
                    const lang = detectLanguage(userPrompt);
                    const reply = respondFromMemoryForFavoriteColor(lang);
                    if (reply) {
                        const aiBubbleContainer = document.createElement('div');
                        const aiEl = createMessageElement(reply, 'ai');
                        chatArea.appendChild(aiEl);
                        await saveMessage(reply, 'ai');
                        resetInputState();
                        return;
                    }
                }
            } catch (e) {
                console.warn('Memory reply failed', e);
            }
            
            const aiMessage = { role: 'ai', text: '...', thought: 'AI Thought: Processing request and waiting for response...' };
            const aiBubbleContainer = createMessageElement(aiMessage.text, aiMessage.role, [], aiMessage.thought);
            chatArea.appendChild(aiBubbleContainer);
            chatArea.scrollTop = chatArea.scrollHeight;
            const textElement = aiBubbleContainer.querySelector('p');
            let thoughtElement = aiBubbleContainer.querySelector('.ai-thought');
            if (thoughtElement && !showAiThoughts) {
                thoughtElement.style.display = 'none';
            }
            
            abortController = new AbortController();

            let payload = {};
            let model = GEMINI_TEXT_MODEL;
            let isImageGen = false;
            let chatHistory = [];
            
            try {
                if (currentMode !== 'Creative_Mode') {
                    chatHistory = await getChatHistory();
                }
            } catch(e) {
                console.warn("Could not retrieve chat history for context:", e);
            }
            
            let userParts = [];
            if (userPrompt) {
                userParts.push({ text: userPrompt });
            }
            if (base64Image && currentMode !== 'Creative_Mode') {
                userParts.push({
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Image
                    }
                });
            }

            const userMessage = {
                role: "user",
                parts: userParts
            };

            if (currentMode === 'Creative_Mode') {
                isImageGen = true;
                model = IMAGEN_MODEL;
                payload = {
                    instances: {
                        prompt: userPrompt 
                    },
                    parameters: {
                        "sampleCount": 1
                    }
                };
            } else {
                let contents = [...chatHistory, userMessage];
                
                let systemInstruction = getSystemInstruction(currentMode);

                payload = {
                    contents: contents,
                    systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined,
                    tools: [{ "google_search": {} }],
                };
                model = GEMINI_TEXT_MODEL;
            }

            let aiResponse = { text: "Napakyas sa pagkonekta sa AI.", sources: [], base64Image: null, thought: 'Error during API call.' };
            let isAborted = false;
            
            try {
                if (thoughtElement && showAiThoughts) {
                     thoughtElement.textContent = `AI Thought: Nagpadala og hangyo sa ${model} gamit ang system instruction para sa ${modeDisplayNameMap[currentMode]}...`;
                }
                
                
                let messages = [];
                if (currentMode === "Creative_Mode") {
                    messages = [
                        { role: "system", content: "You are a creative visual assistant that describes images vividly." },
                        { role: "user", content: userPrompt }
                    ];
                    aiResponse = await callOpenAIAPI(messages, true, abortController.signal);
                } else {
                    const historyMessages = (chatHistory || []).map(h => {
                        const role = (h.role === 'user') ? 'user' : 'assistant';
                        const text = (h.parts && h.parts[0] && h.parts[0].text) ? h.parts[0].text : '';
                        return { role, content: text };
                    }).filter(m => m.content && m.content.length > 0);

                    const contextAnalysis = analyzeConversationContext(userPrompt, chatHistory || historyMessages);
                    const baseSys = getSystemInstruction(currentMode);
                    const smartSys = generateSmartSystemInstruction(baseSys, contextAnalysis);

                    messages = [ { role: "system", content: smartSys } ].concat(historyMessages, [{ role: "user", content: userPrompt }]);

                    aiResponse = await callOpenAIAPI(messages, false, abortController.signal);
                    try {
                        const lang = contextAnalysis.lang || detectLanguage(userPrompt);
                        aiResponse.text = postProcessAIReply(aiResponse.text, { lang });
                    } catch (e) {
                        console.warn('Reply post-processing failed', e);
                    }
                }
                
                if (thoughtElement && showAiThoughts) {
                     thoughtElement.textContent = aiResponse.thought || 'AI Thought: Nadawat ang tubag. Gi-generate ang output.';
                }

            } catch (e) {
                if (e.name === 'AbortError') {
                    aiResponse.text = "AI generation gi-hunong sa user.";
                    isAborted = true;
                    console.warn("API request aborted by user.");
                } else if (e.message.includes("Non-retriable API error: Status 400")) {
                     aiResponse.text = "Error: Invalid request. Palihug i-check ang imong prompt o gamay lang nga hulagway ang i-upload.";
                } else if (e.message.includes("Image generation failed")) {
                    aiResponse.text = "Napakyas ang pag-generate sa hulagway. Palihug sulayi og lain nga prompt.";
                } else {
                     aiResponse.text = "Oops! Network or server error. Palihug sulayi pag-usab. Error: " + e.message.substring(0, 50) + "...";
                }
                aiResponse.thought = 'Error during API call.';
                console.error("Critical API/Network Error:", e);
            } finally {
                abortController = null;
                resetInputState();
            }

            if (!isAborted) {
                if (thoughtElement) {
                    thoughtElement.remove();
                    thoughtElement = null;
                }
    
                if (aiResponse.base64Image) {
                    const imageUrl = `data:image/png;base64,${aiResponse.base64Image}`;
                    const imageEl = document.createElement('img');
                    imageEl.src = imageUrl;
                    imageEl.alt = userPrompt;
                    imageEl.className = 'mt-2 rounded-lg max-w-full h-auto shadow-xl border border-pink-500 shadow-pink-500/50';
                    
                    const aiBubble = aiBubbleContainer.querySelector('.ai-bubble'); 
                    
                    textElement.textContent = `Hulagway gi-generate base sa: "${userPrompt}"`;
                    aiBubble.appendChild(imageEl); 
    
                } else {
                    textElement.textContent = aiResponse.text; 
    
                    if (aiResponse.sources && aiResponse.sources.length > 0) {
                        const sourcesEl = document.createElement('div');
                        sourcesEl.className = 'text-xs mt-2 pt-2 border-t border-gray-600 text-gray-400';
                        sourcesEl.innerHTML = '<strong>Sources:</strong><ul class="list-disc list-inside mt-1">';
                        aiResponse.sources.forEach(source => {
                            sourcesEl.innerHTML += `<li><a href="${source.uri}" target="_blank" class="text-pink-400 hover:text-pink-200 transition">${source.title || source.uri}</a></li>`;
                        });
                        sourcesEl.innerHTML += '</ul>';
                        const aiBubble = aiBubbleContainer.querySelector('.ai-bubble');
                        aiBubble.appendChild(sourcesEl);
                    }
                }
                
                await saveMessage(aiResponse.text, 'ai');
            } else {
                aiBubbleContainer.remove(); 
                displaySystemMessage("AI generation gi-hunong sa user.", true);
            }

            
        }
        
        function resetInputState() {
            const promptInput = document.getElementById('prompt-input');
            const fileInput = document.getElementById('file-upload');
            const sendButton = document.getElementById('send-button');
            const stopButton = document.getElementById('stop-button');

            promptInput.value = '';
            fileInput.value = ''; 
            document.getElementById('file-upload-label').textContent = 'Upload Image';
            document.getElementById('file-upload-label').classList.remove('text-cyan-400');
            document.getElementById('file-upload-label').classList.add('text-gray-400');


            isWaitingForResponse = false;
            sendButton.disabled = true; 
            stopButton.classList.add('hidden');
            
            const chatArea = document.getElementById('chat-area');
            chatArea.scrollTop = chatArea.scrollHeight;
            
            promptInput.style.height = 'auto';
            promptInput.style.height = (promptInput.scrollHeight) + 'px';
        }

        function checkInput() {
            const promptInput = document.getElementById('prompt-input');
            const fileInput = document.getElementById('file-upload');
            const sendButton = document.getElementById('send-button');

            const hasText = promptInput.value.trim().length > 0;
            const hasFile = fileInput.files.length > 0;

            if (isWaitingForResponse) {
                sendButton.disabled = true;
            } else {
                sendButton.disabled = !(hasText || hasFile);
            }
        }
        
        let dragInfo = {
            isDragging: false,
            startX: 0,
            startY: 0,
            offsetX: 200,
            offsetY: 100,
            isClick: true,
        };
        
        function startDrag(e) {
            const robot = document.getElementById('robot-assistant');
            
            dragInfo.isDragging = true;
            dragInfo.isClick = true;
            robot.style.transition = 'none';
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const rect = robot.getBoundingClientRect();
            dragInfo.startX = clientX - rect.left;
            dragInfo.startY = clientY - rect.top;

            robot.style.cursor = 'grabbing';
            e.preventDefault(); 
        }

        function duringDrag(e) {
            if (!dragInfo.isDragging) return;

            const robot = document.getElementById('robot-assistant');
            const parentRect = robot.parentElement.getBoundingClientRect();
            
            dragInfo.isClick = false;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let newLeft = clientX - parentRect.left - dragInfo.startX;
            let newTop = clientY - parentRect.top - dragInfo.startY;

            const robotWidth = robot.offsetWidth;
            const robotHeight = robot.offsetHeight;
            const maxLeft = parentRect.width - robotWidth;
            const maxTop = parentRect.height - robotHeight;

            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));
            
            robot.style.left = `${newLeft}px`;
            robot.style.top = `${newTop}px`;
            
            dragInfo.offsetX = newLeft;
            dragInfo.offsetY = newTop;
        }

        function endDrag(e) {
            if (!dragInfo.isDragging) return;
            
            dragInfo.isDragging = false;
            const robot = document.getElementById('robot-assistant');
            robot.style.cursor = 'grab';
            robot.style.transition = 'box-shadow 0.3s ease';
            
            if (dragInfo.isClick) {
                handleRobotClick(e);
            }
        }

        function ensureRobotBubbleExists() {
            const robot = document.getElementById('robot-assistant');
            if (!robot) return;
            let bubble = document.getElementById('robot-bubble');
            if (!bubble) {
                bubble = document.createElement('div');
                bubble.id = 'robot-bubble';
                bubble.className = 'robot-bubble';
                bubble.style.position = 'absolute';
                bubble.style.bottom = 'calc(100% + 12px)';
                bubble.style.left = '50%';
                bubble.style.transform = 'translateX(-50%)';
                bubble.style.padding = '8px 12px';
                bubble.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.6))';
                bubble.style.border = '1px solid rgba(255,255,255,0.06)';
                bubble.style.borderRadius = '12px';
                bubble.style.fontSize = '13px';
                bubble.style.color = '#ffffff';
                bubble.style.boxShadow = '0 6px 18px rgba(0,0,0,0.6), 0 0 12px rgba(34,211,238,0.06)';
                bubble.style.whiteSpace = 'nowrap';
                bubble.style.zIndex = '20';
                bubble.style.pointerEvents = 'none';
                robot.appendChild(bubble);
            }
            bubble.textContent = 'kumusta Dex!';
            bubble.classList.add('show');
        }

        function handleRobotClick(e) {
            const robot = document.getElementById('robot-assistant');
            ensureRobotBubbleExists();

            const existing = document.getElementById('robot-menu');
            if (existing) {
                existing.remove();
                document.removeEventListener('click', robotMenuDocClick);
                return;
            }

            const menu = document.createElement('div');
            menu.id = 'robot-menu';
            menu.style.position = 'absolute';
            menu.style.left = '50%';
            menu.style.top = '50%';
            menu.style.transform = 'translate(-50%, -50%)';
            menu.style.pointerEvents = 'none';
            menu.style.zIndex = '15';

            function makeOption(label, url, angleDeg, color) {
                const btn = document.createElement('button');
                btn.className = 'robot-option';
                btn.style.pointerEvents = 'auto';
                btn.style.position = 'absolute';
                btn.style.width = '64px';
                btn.style.height = '64px';
                btn.style.borderRadius = '50%';
                btn.style.border = '2px solid rgba(255,255,255,0.08)';
                btn.style.display = 'flex';
                btn.style.alignItems = 'center';
                btn.style.justifyContent = 'center';
                btn.style.color = '#fff';
                btn.style.fontSize = '14px';
                btn.style.fontWeight = '700';
                btn.style.cursor = 'pointer';
                btn.style.background = `radial-gradient(circle at 30% 20%, ${color}22, #111 60%)`;
                btn.style.boxShadow = `0 0 18px ${color}, 0 0 36px ${color}66`;
                const r = 90;
                const rad = angleDeg * Math.PI / 180;
                const dx = Math.round(Math.cos(rad) * r);
                const dy = Math.round(Math.sin(rad) * r) * -1;
                btn.style.left = '50%';
                btn.style.top = '50%';
                btn.style.transform = `translate(${dx}px, ${dy}px) translate(-50%, -50%)`;

                btn.innerHTML = `<span style="text-align:center;display:block;line-height:1">${label}</span>`;
                btn.onclick = (ev) => {
                    ev.stopPropagation();
                    window.location.href = url;
                };
                return btn;
            }

            const optA = makeOption('A', 'game1.html', -90, '#ff4d6d');
            const optB = makeOption('B', 'game2.html', 150, '#6de0ff');
            const optC = makeOption('C', 'game3.html', 30, '#b86dff');
            
            const hub = document.createElement('div');
            hub.style.position = 'absolute';
            hub.style.left = '50%';
            hub.style.top = '50%';
            hub.style.transform = 'translate(-50%, -50%)';
            hub.style.width = '44px';
            hub.style.height = '44px';
            hub.style.borderRadius = '50%';
            hub.style.background = 'linear-gradient(135deg,#111 0%, #222 100%)';
            hub.style.boxShadow = '0 0 18px rgba(34,211,238,0.18), inset 0 0 8px rgba(255,255,255,0.02)';
            hub.style.border = '1px solid rgba(255,255,255,0.06)';
            hub.style.display = 'flex';
            hub.style.alignItems = 'center';
            hub.style.justifyContent = 'center';
            hub.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#7ef0ff" stroke-width="1.5"><circle cx="12" cy="12" r="3"></circle></svg>';

            menu.appendChild(optA);
            menu.appendChild(optB);
            menu.appendChild(optC);
            menu.appendChild(hub);

            robot.appendChild(menu);

            function robotMenuDocClick(ev) {
                if (!menu.contains(ev.target) && ev.target !== robot && !robot.contains(ev.target)) {
                    const m = document.getElementById('robot-menu');
                    if (m) m.remove();
                    document.removeEventListener('click', robotMenuDocClick);
                }
            }
            setTimeout(() => document.addEventListener('click', robotMenuDocClick), 120);
        }

        window.onload = async () => {
            if (firebaseConfig) {
                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Custom token sign-in failed. Falling back to anonymous.", e);
                        return signInAnonymously(auth);
                    });
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        setMode('General_Chat');
                    } else {
                        displayError("Authentication failed. Cannot access Firestore.");
                    }
                });

            } else {
                displayError("Firebase configuration is missing. Using local, non-persistent chat.");
                userId = crypto.randomUUID();
                setMode('General_Chat');
                document.getElementById('user-id-display').textContent = `Local ID: ${userId.substring(0, 8)}...`;
            }

            document.getElementById('new-chat-btn').addEventListener('click', createNewChat);
            const resetBtn = document.getElementById('reset-memory-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    clearLocalHistory();
                    document.getElementById('chat-area').innerHTML = '';
                    displaySystemMessage('Local memory cleared. Nagsugod ug bag-ong session.');
                });
            }
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('toggle-ai-thoughts').addEventListener('click', handleShowAiThoughtsToggle);
            
            document.getElementById('open-settings-btn').addEventListener('click', openSettingsModal);
            document.getElementById('close-settings-btn').addEventListener('click', closeSettingsModal);
            document.getElementById('test-key-btn').addEventListener('click', testApiKey);
            document.getElementById('save-key-btn').addEventListener('click', saveApiKey);
            document.getElementById('clear-key-btn').addEventListener('click', clearApiKey);
            document.getElementById('paste-test-btn').addEventListener('click', pasteAndTest);
            
            document.getElementById('settings-modal').addEventListener('click', (e) => {
                if (e.target.id === 'settings-modal') {
                    closeSettingsModal();
                }
            });
            
            document.getElementById('api-key-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    testApiKey();
                } else if (e.key === 'Enter') {
                    saveApiKey();
                }
            });
            
            document.getElementById('prompt-input').addEventListener('input', checkInput);
            document.getElementById('prompt-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !document.getElementById('send-button').disabled) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.getElementById('file-upload').addEventListener('change', (e) => {
                const fileLabel = document.getElementById('file-upload-label');
                const fileName = e.target.files[0]?.name;
                fileLabel.textContent = fileName ? `File: ${fileName}` : 'Upload Image';
                fileLabel.classList.remove('text-gray-400');
                fileLabel.classList.add('text-cyan-400');
                checkInput();
            });
            
            const robot = document.getElementById('robot-assistant');
            
            robot.style.left = `${dragInfo.offsetX}px`;
            robot.style.top = `${dragInfo.offsetY}px`;
            
            robot.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', duringDrag);
            document.addEventListener('mouseup', endDrag);
            
            robot.addEventListener('touchstart', startDrag);
            document.addEventListener('touchmove', duringDrag);
            document.addEventListener('touchend', endDrag);
            
            robot.addEventListener('click', (e) => { e.preventDefault(); });

            window.setMode = setMode;
            window.handleNeonIndicatorClick = handleNeonIndicatorClick; 

            try {
                const keyInfo = detectApiKeySource();
                console.info('API key detection result:', keyInfo);
                if (keyInfo && keyInfo.source && keyInfo.source !== 'none') {
                    displaySystemMessage(`API key detected from ${keyInfo.source} (${keyInfo.value}).`, false);
                } else {
                    displaySystemMessage('Missing OpenAI API key. Open Settings and paste your key, or add a meta tag or embedded element with your key.', true);
                }
            } catch (e) {
                console.warn('API key auto-detection failed', e);
            }
        };
    </script>
    <meta name="gexpert-api-key" content="">
</head>
<body>
    <nav class="app-navbar">
        <div class="navbar-brand-chat">üí¨ G-EXPERT CHAT</div>
        <div class="nav-links-chat">
            <a href="qrcode.html" class="nav-link-chat">üåê QR Generator</a>
            <a href="calculator.html" class="nav-link-chat">Calculator</a>
            <a href="videodown.html" class="nav-link-chat">download</a>Calculator
        </div>
    </nav>

    <div id="embedded-api-key" style="display:none"></div>
    <div id="app" class="flex h-screen">
        
        <div class="sidebar flex flex-col h-full sticky top-0 shadow-2xl shadow-pink-500/50">
            <h1 class="text-3xl font-extrabold mb-6 border-b pb-2 text-white">
                <span class="text-pink-400">G-</span><span class="text-cyan-400">Expert</span> Chat
            </h1>
            <button id="new-chat-btn" class="flex items-center justify-center new-chat-button font-semibold py-3 px-4 rounded-xl mb-6 transition duration-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                New Chat
            </button>
            <button id="reset-memory-btn" class="flex items-center justify-center bg-gray-800 text-gray-300 font-medium py-2 px-3 rounded-xl mb-4 transition duration-200 hover:bg-gray-700" title="Reset local chat memory">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4l3-7 4 18 3-9h4"></path></svg>
                Reset Memory
            </button>
            <button id="toggle-ai-thoughts" class="bg-gray-800 hover:bg-gray-700 text-gray-400 font-medium text-sm py-2 px-4 rounded-xl mb-6 transition duration-200">
                Show AI Thoughts
            </button>
            <button id="open-settings-btn" class="flex items-center justify-center bg-pink-900 hover:bg-pink-800 text-pink-200 font-medium text-sm py-2 px-4 rounded-xl mb-6 transition duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                API Settings
            </button>
            
            <p class="text-xs font-bold uppercase text-pink-400 mb-2">EXPERT MODEL MODES</p>
            <div id="model-modes" class="flex flex-col gap-1 overflow-y-auto flex-grow">
                <div id="mode-General_Chat" onclick="setMode('General_Chat')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üí¨</span> General Chat
                </div>
                <div id="mode-Code_Creator" onclick="setMode('Code_Creator')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üíª</span> Code Creator
                </div>
                <div id="mode-Code_Generator_V2" onclick="setMode('Code_Generator_V2')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üöÄ</span> Code Generator V2
                </div>
                <div id="mode-Creative_Mode" onclick="setMode('Creative_Mode')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üñºÔ∏è</span> Creative Mode (Image Gen)
                </div>
                <div id="mode-Academic_Writer" onclick="setMode('Academic_Writer')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üìö</span> Academic Writer
                </div>
                <div id="mode-Data_Analyst" onclick="setMode('Data_Analyst')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üìä</span> Data Analyst
                </div>
                <div id="mode-Technical_Support" onclick="setMode('Technical_Support')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üõ†Ô∏è</span> Technical Support
                </div>
                <div id="mode-Marketing_Strategist" onclick="setMode('Marketing_Strategist')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üìà</span> Marketing Strategist
                </div>
                <div id="mode-Financial_Advisor" onclick="setMode('Financial_Advisor')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üí∞</span> Financial Advisor
                </div>
                <div id="mode-Legal_Assistant" onclick="setMode('Legal_Assistant')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">‚öñÔ∏è</span> Legal Assistant
                </div>
                <div id="mode-Storyteller" onclick="setMode('Storyteller')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">‚úçÔ∏è</span> Storyteller
                </div>
                <div id="mode-Filipino_Translator" onclick="setMode('Filipino_Translator')" class="model-mode-item flex items-center">
                    <span class="mr-2 text-xl">üáµüá≠</span> Filipino Translator
                </div>
                
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <p class="text-xs text-gray-500">App Credit Guinea,: <span class="font-mono text-cyan-400">{{ appId }}</span></p>
                <p class="text-xs text-gray-500">User ID: <span id="user-id-display" class="font-mono text-cyan-400">Loading...</span></p>
            </div>
        </div>

        <div class="main-content">
            <div class="py-3 px-8 text-gray-400 shadow-md flex justify-between items-center border-b border-pink-500 flex-shrink-0">
                <span class="text-lg font-medium">Current Expert Mode: <span id="current-mode-display" class="font-bold text-cyan-400">General Chat</span></span>
            </div>
            
            <div id="neon-indicator">
                <span class="text-xs uppercase text-gray-500 mr-4">Neon Filters:</span>
                <div id="light-1" class="neon-light active" data-filter="flow" data-light="1" onclick="handleNeonIndicatorClick(1)" title="Mode 1: Flow (Soft Movement)"></div>
                <div id="light-2" class="neon-light" data-filter="pulse" data-light="2" onclick="handleNeonIndicatorClick(2)" title="Mode 2: Pulse (Subtle Ripple)"></div>
                <div id="light-3" class="neon-light" data-filter="wash" data-light="3" onclick="handleNeonIndicatorClick(3)" title="Mode 3: Wash (Ambient Color)"></div>
            </div>
            
            <div id="robot-assistant" style="transform: none;">
                <div id="robot-bubble" class="robot-bubble">Kumusta, Dex!</div>
                <svg viewBox="0 0 100 100" class="w-full h-full robot-svg-glow" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="40" fill="#ffffff" />
                    <rect x="35" y="65" width="30" height="20" rx="10" ry="10" fill="#ffffff" />
                    <rect x="30" y="2" width="5" height="15" rx="2" ry="2" fill="var(--color-cyan)" />
                    <rect x="65" y="2" width="5" height="15" rx="2" ry="2" fill="var(--color-cyan)" />
                    <path d="M 20 40 Q 50 30, 80 40 L 80 50 Q 50 60, 20 50 Z" fill="rgba(34, 211, 238, 0.2)" stroke="var(--color-cyan)" stroke-width="1.5"/>
                    <path d="M 30 45 C 35 40, 40 40, 45 45" fill="none" stroke="#ffffff" stroke-width="2" style="filter: drop-shadow(0 0 5px #fff);"/>
                    <path d="M 55 45 C 60 40, 65 40, 70 45" fill="none" stroke="#ffffff" stroke-width="2" style="filter: drop-shadow(0 0 5px #fff);"/>
                    <circle cx="50" cy="65" r="15" fill="var(--color-cyan)" style="filter: drop-shadow(0 0 5px rgba(34, 211, 238, 0.5));"/>
                    <path d="M 65 70 L 80 55 L 75 75 Z" fill="#ffffff" style="filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));"/>
                    <path d="M 35 70 L 20 55 L 25 75 Z" fill="#ffffff" style="filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));"/>
                </svg>
            </div>
            
            <div id="chat-area" class="chat-area bg-General_Chat filter-flow">
            </div>

            <div class="input-area">
                <div class="flex items-end space-x-4 w-full max-w-5xl mx-auto p-3 rounded-xl input-box">
                    
                    <label for="file-upload" id="upload-image-btn" class="p-3 text-pink-400 hover:text-pink-200 cursor-pointer transition flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12"></path></svg>
                    </label>
                    <input type="file" id="file-upload" accept="image/*" class="hidden">

                    <div class="flex-grow relative">
                        <textarea id="prompt-input" placeholder="Type your message or image description..." 
                                class="w-full rounded-lg focus:outline-none transition duration-200 resize-none" rows="1"></textarea>
                        <label for="file-upload" id="file-upload-label" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 transition duration-200 pointer-events-none">Upload Image</label>
                    </div>

                    <button id="send-button" class="send-button rounded-xl flex-shrink-0" disabled>
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                    
                    <button id="stop-button" class="send-button rounded-xl flex-shrink-0 stop-button-style hidden" onclick="window.stopTyping()" title="Stop AI Generation">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12H3"></path></svg>
                    </button>
                </div>
                <p id="input-hint" class="text-xs text-gray-500 mt-2 text-center w-full max-w-5xl mx-auto">
                    Multimodal Chat: Ask questions or upload an image. The AI is an expert in this field.
                </p>
            </div>
            
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border-2 border-pink-500 rounded-2xl p-8 w-96 shadow-2xl shadow-pink-500/50">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                <svg class="w-6 h-6 mr-3 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                API Key Settings
            </h2>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-300 mb-2">Paste your OpenAI API Key:</label>
                <input type="password" id="api-key-input" placeholder="sk-..." class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:border-cyan-400 focus:outline-none transition" />
            </div>
            
            <div id="settings-status" class="mb-6 p-3 rounded-lg bg-gray-800 text-sm text-gray-300 min-h-12 flex items-center">
                Ready to accept API key
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="test-key-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-3 rounded-lg transition duration-200 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Test
                </button>
                <button id="save-key-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-2 px-3 rounded-lg transition duration-200 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    Save
                </button>
                <button id="paste-test-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-lg transition duration-200 col-span-2 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    Paste & Test
                </button>
            </div>

            <button id="clear-key-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-lg transition duration-200 mb-4">
                Clear API Key
            </button>
            
            <button id="close-settings-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-100 font-medium py-2 px-3 rounded-lg transition duration-200">
                Close Settings
            </button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
             const appIdEl = document.querySelector('.text-xs.text-gray-500 span');
             if (appIdEl) {
                 appIdEl.textContent = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
             }
             
             const textarea = document.getElementById('prompt-input');
             textarea.addEventListener('input', function() {
                 this.style.height = 'auto';
                 this.style.height = (this.scrollHeight) + 'px';
             });
        });
</script>
</body>
</html>